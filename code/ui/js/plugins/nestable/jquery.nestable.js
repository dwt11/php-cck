(function(M,P,O,L){var N="ontouchstart" in O;var I=(function(){var B=O.createElement("div"),A=O.documentElement;if(!("pointerEvents" in B.style)){return false}B.style.pointerEvents="auto";B.style.pointerEvents="x";A.appendChild(B);var C=P.getComputedStyle&&P.getComputedStyle(B,"").pointerEvents==="auto";A.removeChild(B);return !!C})();var K={listNodeName:"ol",itemNodeName:"li",rootClass:"dd",listClass:"dd-list",itemClass:"dd-item",dragClass:"dd-dragel",handleClass:"dd-handle",collapsedClass:"dd-collapsed",placeClass:"dd-placeholder",noDragClass:"dd-nodrag",emptyClass:"dd-empty",expandBtnHTML:'<button data-action="expand" type="button">展开</button>',collapseBtnHTML:'<button data-action="collapse" type="button">关闭</button>',group:0,maxDepth:5,threshold:20};function J(B,A){this.w=M(O);this.el=M(B);this.options=M.extend({},K,A);this.init()}J.prototype={init:function(){var D=this;D.reset();D.el.data("nestable-group",this.options.group);D.placeEl=M('<div class="'+D.options.placeClass+'"/>');M.each(this.el.find(D.options.itemNodeName),function(E,F){D.setParent(M(F))});D.el.on("click","button",function(F){if(D.dragEl){return}var G=M(F.currentTarget),H=G.data("action"),E=G.parent(D.options.itemNodeName);if(H==="collapse"){D.collapseItem(E)}if(H==="expand"){D.expandItem(E)}});var B=function(E){var F=M(E.target);if(!F.hasClass(D.options.handleClass)){if(F.closest("."+D.options.noDragClass).length){return}F=F.closest("."+D.options.handleClass)}if(!F.length||D.dragEl){return}D.isTouch=/^touch/.test(E.type);if(D.isTouch&&E.touches.length!==1){return}E.preventDefault()};var A=function(E){if(D.dragEl){E.preventDefault();D.dragMove(E.touches?E.touches[0]:E)}};var C=function(E){if(D.dragEl){E.preventDefault();D.dragStop(E.touches?E.touches[0]:E)}};if(N){D.el[0].addEventListener("touchstart",B,false);P.addEventListener("touchmove",A,false);P.addEventListener("touchend",C,false);P.addEventListener("touchcancel",C,false)}D.el.on("mousedown",B);D.w.on("mousemove",A);D.w.on("mouseup",C)},serialize:function(){var A,B=0,C=this;step=function(G,D){var F=[],E=G.children(C.options.itemNodeName);E.each(function(){var H=M(this),T=M.extend({},H.data()),S=H.children(C.options.listNodeName);if(S.length){T.children=step(S,D+1)}F.push(T)});return F};A=step(C.el.find(C.options.listNodeName).first(),B);return A},serialise:function(){return this.serialize()},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0};this.isTouch=false;this.moving=false;this.dragEl=null;this.dragRootEl=null;this.dragDepth=0;this.hasNewRoot=false;this.pointEl=null},expandItem:function(A){A.removeClass(this.options.collapsedClass);A.children('[data-action="expand"]').hide();A.children('[data-action="collapse"]').show();A.children(this.options.listNodeName).show()},collapseItem:function(A){var B=A.children(this.options.listNodeName);if(B.length){A.addClass(this.options.collapsedClass);A.children('[data-action="collapse"]').hide();A.children('[data-action="expand"]').show();A.children(this.options.listNodeName).hide()}},expandAll:function(){var A=this;A.el.find(A.options.itemNodeName).each(function(){A.expandItem(M(this))})},collapseAll:function(){var A=this;A.el.find(A.options.itemNodeName).each(function(){A.collapseItem(M(this))})},setParent:function(A){if(A.children(this.options.listNodeName).length){A.prepend(M(this.options.expandBtnHTML));A.prepend(M(this.options.collapseBtnHTML))}A.children('[data-action="expand"]').hide()},unsetParent:function(A){A.removeClass(this.options.collapsedClass);A.children("[data-action]").remove();A.children(this.options.listNodeName).remove()},dragStart:function(A){var D=this.mouse,C=M(A.target),B=C.closest(this.options.itemNodeName);this.placeEl.css("height",B.height());D.offsetX=A.offsetX!==L?A.offsetX:A.pageX-C.offset().left;D.offsetY=A.offsetY!==L?A.offsetY:A.pageY-C.offset().top;D.startX=D.lastX=A.pageX;D.startY=D.lastY=A.pageY;this.dragRootEl=this.el;this.dragEl=M(O.createElement(this.options.listNodeName)).addClass(this.options.listClass+" "+this.options.dragClass);this.dragEl.css("width",B.width());B.after(this.placeEl);B[0].parentNode.removeChild(B[0]);B.appendTo(this.dragEl);M(O.body).append(this.dragEl);this.dragEl.css({"left":A.pageX-D.offsetX,"top":A.pageY-D.offsetY});var G,E,F=this.dragEl.find(this.options.itemNodeName);for(G=0;G<F.length;G++){E=M(F[G]).parents(this.options.listNodeName).length;if(E>this.dragDepth){this.dragDepth=E}}},dragStop:function(B){var A=this.dragEl.children(this.options.itemNodeName).first();A[0].parentNode.removeChild(A[0]);this.placeEl.replaceWith(A);this.dragEl.remove();this.el.trigger("change");if(this.hasNewRoot){this.dragRootEl.trigger("change")}this.reset()},dragMove:function(B){var Z,X,V,Y,W,G=this.options,H=this.mouse;this.dragEl.css({"left":B.pageX-H.offsetX,"top":B.pageY-H.offsetY});H.lastX=H.nowX;H.lastY=H.nowY;H.nowX=B.pageX;H.nowY=B.pageY;H.distX=H.nowX-H.lastX;H.distY=H.nowY-H.lastY;H.lastDirX=H.dirX;H.lastDirY=H.dirY;H.dirX=H.distX===0?0:H.distX>0?1:-1;H.dirY=H.distY===0?0:H.distY>0?1:-1;var A=Math.abs(H.distX)>Math.abs(H.distY)?1:0;if(!H.moving){H.dirAx=A;H.moving=true;return}if(H.dirAx!==A){H.distAxX=0;H.distAxY=0}else{H.distAxX+=Math.abs(H.distX);if(H.dirX!==0&&H.dirX!==H.lastDirX){H.distAxX=0}H.distAxY+=Math.abs(H.distY);if(H.dirY!==0&&H.dirY!==H.lastDirY){H.distAxY=0}}H.dirAx=A;if(H.dirAx&&H.distAxX>=G.threshold){H.distAxX=0;V=this.placeEl.prev(G.itemNodeName);if(H.distX>0&&V.length&&!V.hasClass(G.collapsedClass)){Z=V.find(G.listNodeName).last();W=this.placeEl.parents(G.listNodeName).length;if(W+this.dragDepth<=G.maxDepth){if(!Z.length){Z=M("<"+G.listNodeName+"/>").addClass(G.listClass);Z.append(this.placeEl);V.append(Z);this.setParent(V)}else{Z=V.children(G.listNodeName).last();Z.append(this.placeEl)}}}if(H.distX<0){Y=this.placeEl.next(G.itemNodeName);if(!Y.length){X=this.placeEl.parent();this.placeEl.closest(G.itemNodeName).after(this.placeEl);if(!X.children().length){this.unsetParent(X.parent())}}}}var D=false;if(!I){this.dragEl[0].style.visibility="hidden"}this.pointEl=M(O.elementFromPoint(B.pageX-O.body.scrollLeft,B.pageY-(P.pageYOffset||O.documentElement.scrollTop)));if(!I){this.dragEl[0].style.visibility="visible"}if(this.pointEl.hasClass(G.handleClass)){this.pointEl=this.pointEl.parent(G.itemNodeName)}if(this.pointEl.hasClass(G.emptyClass)){D=true}else{if(!this.pointEl.length||!this.pointEl.hasClass(G.itemClass)){return}}var C=this.pointEl.closest("."+G.rootClass),E=this.dragRootEl.data("nestable-id")!==C.data("nestable-id");if(!H.dirAx||E||D){if(E&&G.group!==C.data("nestable-group")){return}W=this.dragDepth-1+this.pointEl.parents(G.listNodeName).length;if(W>G.maxDepth){return}var F=B.pageY<(this.pointEl.offset().top+this.pointEl.height()/2);X=this.placeEl.parent();if(D){Z=M(O.createElement(G.listNodeName)).addClass(G.listClass);Z.append(this.placeEl);this.pointEl.replaceWith(Z)}else{if(F){this.pointEl.before(this.placeEl)}else{this.pointEl.after(this.placeEl)}}if(!X.children().length){this.unsetParent(X.parent())}if(!this.dragRootEl.find(G.itemNodeName).length){this.dragRootEl.append('<div class="'+G.emptyClass+'"/>')}if(E){this.dragRootEl=C;this.hasNewRoot=this.el[0]!==this.dragRootEl[0]}}}};M.fn.nestable=function(C){var A=this,B=this;A.each(function(){var D=M(this).data("nestable");if(!D){M(this).data("nestable",new J(this,C));M(this).data("nestable-id",new Date().getTime())}else{if(typeof C==="string"&&typeof D[C]==="function"){B=D[C]()}}});return B||A}})(window.jQuery||window.Zepto,window,document);