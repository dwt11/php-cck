(function(B){if(typeof define==="function"&&define.amd){define(["jquery","ChineseDistricts"],B)}else{if(typeof exports==="object"){B(require("jquery"),require("ChineseDistricts"))}else{B(jQuery,ChineseDistricts)}}})(function(M,P){if(typeof P==="undefined"){throw new Error('The file "city-picker.data.js" must be included first!')}var N="citypicker";var K="change."+N;var O="province";var L="city";var I="district";function J(B,A){this.$element=M(B);this.$dropdown=null;this.options=M.extend({},J.DEFAULTS,M.isPlainObject(A)&&A);this.active=false;this.dems=[];this.needBlur=false;this.init()}J.prototype={constructor:J,init:function(){this.defineDems();this.render();this.bind();this.active=true},render:function(){var E=this.getPosition(),A=this.$element.attr("placeholder")||this.options.placeholder,C='<span class="city-picker-span" style="'+this.getWidthStyle(E.width)+"height:"+E.height+"px;line-height:"+(E.height-1)+'px;">'+(A?'<span class="placeholder">'+A+"</span>":"")+'<span class="title"></span><div class="arrow"></div></span>',B='<div class="city-picker-dropdown" style="left:0px;top:100%;'+this.getWidthStyle(E.width,true)+'"><div class="city-select-wrap"><div class="city-select-tab"><a class="active" data-count="province">省份</a>'+(this.includeDem("city")?'<a data-count="city">城市</a>':"")+(this.includeDem("district")?'<a data-count="district">区县</a>':"")+'</div><div class="city-select-content" ><div class="city-select province" data-count="province" ></div>'+(this.includeDem("city")?'<div class="city-select city" data-count="city" ></div>':"")+(this.includeDem("district")?'<div class="city-select district" data-count="district"></div>':"")+"</div></div>";this.$element.addClass("city-picker-input");this.$textspan=M(C).insertAfter(this.$element);this.$dropdown=M(B).insertAfter(this.$textspan);var D=this.$dropdown.find(".city-select");M.each(this.dems,M.proxy(function(G,F){this["$"+F]=D.filter("."+F+"")},this));this.refresh()},refresh:function(B){var C=this.$dropdown.find(".city-select");C.data("item",null);var A=this.$element.val()||"";A=A.split("/");M.each(this.dems,M.proxy(function(E,D){if(A[E]&&E<A.length){this.options[D]=A[E]}else{if(B){this.options[D]=""}}this.output(D)},this));this.tab(O);this.feedText();this.feedVal()},defineDems:function(){var A=false;M.each([O,L,I],M.proxy(function(B,C){if(!A){this.dems.push(C)}if(C===this.options.level){A=true}},this))},includeDem:function(A){return M.inArray(A,this.dems)!==-1},getPosition:function(){var C,B,D,A,E;C=this.$element.position();A=this.getSize(this.$element);B=A.height;D=A.width;if(this.options.responsive){E=this.$element.offsetParent().width();if(E){D=D/E;if(D>0.99){D=1}D=D*100+"%"}}return{top:C.top||0,left:C.left||0,height:B,width:D}},getSize:function(B){var A,D,C;if(!B.is(":visible")){A=M("<div />").appendTo(M("body"));A.css({"position":"absolute !important","visibility":"hidden !important","display":"block !important"});D=B.clone().appendTo(A);C={width:D.outerWidth(),height:D.outerHeight()};A.remove()}else{C={width:B.outerWidth(),height:B.outerHeight()}}return C},getWidthStyle:function(B,A){if(this.options.responsive&&!M.isNumeric(B)){return"width:"+B+";"}else{return"width:"+(A?Math.max(270,B):B)+"px;"}},bind:function(){var A=this;M(document).on("click",(this._mouteclick=function(B){var E=M(B.target);var C,F,D;if(E.is(".city-picker-span")){F=E}else{if(E.is(".city-picker-span *")){F=E.parents(".city-picker-span")}}if(E.is(".city-picker-input")){D=E}if(E.is(".city-picker-dropdown")){C=E}else{if(E.is(".city-picker-dropdown *")){C=E.parents(".city-picker-dropdown")}}if((!D&&!F&&!C)||(F&&F.get(0)!==A.$textspan.get(0))||(D&&D.get(0)!==A.$element.get(0))||(C&&C.get(0)!==A.$dropdown.get(0))){A.close(true)}}));this.$element.on("change",(this._changeElement=M.proxy(function(){this.close(true);this.refresh(true)},this))).on("focus",(this._focusElement=M.proxy(function(){this.needBlur=true;this.open()},this))).on("blur",(this._blurElement=M.proxy(function(){if(this.needBlur){this.needBlur=false;this.close(true)}},this)));this.$textspan.on("click",function(B){var C=M(B.target),D;A.needBlur=false;if(C.is(".select-item")){D=C.data("count");A.open(D)}else{if(A.$dropdown.is(":visible")){A.close()}else{A.open()}}}).on("mousedown",function(){A.needBlur=false});this.$dropdown.on("click",".city-select a",function(){var B=M(this).parents(".city-select");var D=B.find("a.active");var C=B.next().length===0;D.removeClass("active");M(this).addClass("active");if(D.data("code")!==M(this).data("code")){B.data("item",{address:M(this).attr("title"),code:M(this).data("code")});M(this).trigger(K);A.feedText();A.feedVal(true);if(C){A.close()}}}).on("click",".city-select-tab a",function(){if(!M(this).hasClass("active")){var B=M(this).data("count");A.tab(B)}}).on("mousedown",function(){A.needBlur=false});if(this.$province){this.$province.on(K,(this._changeProvince=M.proxy(function(){this.output(L);this.output(I);this.tab(L)},this)))}if(this.$city){this.$city.on(K,(this._changeCity=M.proxy(function(){this.output(I);this.tab(I)},this)))}},open:function(A){A=A||O;this.$dropdown.show();this.$textspan.addClass("open").addClass("focus");this.tab(A)},close:function(A){this.$dropdown.hide();this.$textspan.removeClass("open");if(A){this.$textspan.removeClass("focus")}},unbind:function(){M(document).off("click",this._mouteclick);this.$element.off("change",this._changeElement);this.$element.off("focus",this._focusElement);this.$element.off("blur",this._blurElement);this.$textspan.off("click");this.$textspan.off("mousedown");this.$dropdown.off("click");this.$dropdown.off("mousedown");if(this.$province){this.$province.off(K,this._changeProvince)}if(this.$city){this.$city.off(K,this._changeCity)}},getText:function(){var A="";this.$dropdown.find(".city-select").each(function(){var B=M(this).data("item"),C=M(this).data("count");if(B){A+=(M(this).hasClass("province")?"":"/")+'<span id="province" class="select-item" data-count="'+C+'" data-code="'+B.code+'">'+B.address+"</span>"}});return A},getPlaceHolder:function(){return this.$element.attr("placeholder")||this.options.placeholder},feedText:function(){var A=this.getText();if(A){this.$textspan.find(">.placeholder").hide();this.$textspan.find(">.title").html(this.getText()).show()}else{this.$textspan.find(">.placeholder").text(this.getPlaceHolder()).show();this.$textspan.find(">.title").html("").hide()}},getVal:function(){var A="";this.$dropdown.find(".city-select").each(function(){var B=M(this).data("item");if(B){A+=(M(this).hasClass("province")?"":"/")+B.address}});return A},feedVal:function(A){this.$element.val(this.getVal());if(A){this.$element.trigger("cp:updated")}},output:function(D){var C=this.options;var G=this["$"+D];var A=D===O?{}:[];var H;var B;var E;var R=null;var F;if(!G||!G.length){return}H=G.data("item");F=(H?H.address:null)||C[D];E=(D===O?86:D===L?this.$province&&this.$province.find(".active").data("code"):D===I?this.$city&&this.$city.find(".active").data("code"):E);B=M.isNumeric(E)?P[E]:null;if(M.isPlainObject(B)){M.each(B,function(W,X){var Q;if(D===O){Q=[];for(var V=0;V<X.length;V++){if(X[V].address===F){R={code:X[V].code,address:X[V].address}}Q.push({code:X[V].code,address:X[V].address,selected:X[V].address===F})}A[W]=Q}else{if(X===F){R={code:W,address:X}}A.push({code:W,address:X,selected:X===F})}})}G.html(D===O?this.getProvinceList(A):this.getList(A,D));G.data("item",R)},getProvinceList:function(C){var A=[],D=this,B=this.options.simple;M.each(C,function(F,E){A.push('<dl class="clearfix">');A.push("<dt>"+F+"</dt><dd>");M.each(E,function(H,G){A.push('<a title="'+(G.address||"")+'" data-code="'+(G.code||"")+'" class="'+(G.selected?" active":"")+'">'+(B?D.simplize(G.address,O):G.address)+"</a>")});A.push("</dd></dl>")});return A.join("")},getList:function(D,B){var C=[],A=this,E=this.options.simple;C.push('<dl class="clearfix"><dd>');M.each(D,function(F,G){C.push('<a title="'+(G.address||"")+'" data-code="'+(G.code||"")+'" class="'+(G.selected?" active":"")+'">'+(E?A.simplize(G.address,B):G.address)+"</a>")});C.push("</dd></dl>");return C.join("")},simplize:function(B,A){B=B||"";if(A===O){return B.replace(/[省,市,自治区,壮族,回族,维吾尔]/g,"")}else{if(A===L){return B.replace(/[市,地区,回族,蒙古,苗族,白族,傣族,景颇族,藏族,彝族,壮族,傈僳族,布依族,侗族]/g,"").replace("哈萨克","").replace("自治州","").replace(/自治县/,"")}else{if(A===I){return B.length>2?B.replace(/[市,区,县,旗]/g,""):B}}}},tab:function(B){var E=this.$dropdown.find(".city-select");var D=this.$dropdown.find(".city-select-tab > a");var C=this["$"+B];var A=this.$dropdown.find('.city-select-tab > a[data-count="'+B+'"]');if(C){E.hide();C.show();D.removeClass("active");A.addClass("active")}},reset:function(){this.$element.val(null).trigger("change")},destroy:function(){this.unbind();this.$element.removeData(N).removeClass("city-picker-input");this.$textspan.remove();this.$dropdown.remove()}};J.DEFAULTS={simple:false,responsive:false,placeholder:"请选择省/市/区",level:"district",province:"",city:"",district:""};J.setDefaults=function(A){M.extend(J.DEFAULTS,A)};J.other=M.fn.citypicker;M.fn.citypicker=function(A){var B=[].slice.call(arguments,1);return this.each(function(){var C=M(this);var D=C.data(N);var E;var F;if(!D){if(/destroy/.test(A)){return}E=M.extend({},C.data(),M.isPlainObject(A)&&A);C.data(N,(D=new J(this,E)))}if(typeof A==="string"&&M.isFunction(F=D[A])){F.apply(D,B)}})};M.fn.citypicker.Constructor=J;M.fn.citypicker.setDefaults=J.setDefaults;M.fn.citypicker.noConflict=function(){M.fn.citypicker=J.other;return this};M(function(){M('[data-toggle="city-picker"]').citypicker()})});