(function(Av){var Ao=Av.Markdown=function Ao(A){switch(typeof A){case"undefined":this.dialect=Ao.dialects.Gruber;break;case"object":this.dialect=A;break;default:if(A in Ao.dialects){this.dialect=Ao.dialects[A]}else{throw new Error("Unknown Markdown dialect '"+String(A)+"'")}break}this.em_state=[];this.strong_state=[];this.debug_indent=""};Av.parse=function(B,C){var A=new Ao(C);return A.toTree(B)};Av.toHTML=function z(A,D,B){var C=Av.toHTMLTree(A,D,B);return Av.renderJsonML(C)};Av.toHTMLTree=function AE(F,C,E){if(typeof F==="string"){F=this.parse(F,C)}var B=Ar(F),D={};if(B&&B.references){D=B.references}var A=Ag(F,D,E);Ay(A);return A};function Ab(){return"Markdown.mk_block( "+uneval(this.toString())+", "+uneval(this.trailing)+", "+uneval(this.lineNumber)+" )"}function w(){var A=require("util");return"Markdown.mk_block( "+A.inspect(this.toString())+", "+A.inspect(this.trailing)+", "+A.inspect(this.lineNumber)+" )"}var Af=Ao.mk_block=function(B,A,D){if(arguments.length==1){A="\n\n"}var C=new String(B);C.trailing=A;C.inspect=w;C.toSource=Ab;if(D!=undefined){C.lineNumber=D}return C};function Al(C){var B=0,A=-1;while((A=C.indexOf("\n",A+1))!==-1){B++}return B}Ao.prototype.split_blocks=function t(F,C){var B=/([\s\S]+?)($|\n(?:\s*\n|$)+)/g,A=[],E;var D=1;if((E=/^(\s*\n)/.exec(F))!=null){D+=Al(E[0]);B.lastIndex=E[0].length}while((E=B.exec(F))!==null){A.push(Af(E[1],E[2],D));D+=Al(E[0])}return A};Ao.prototype.processBlock=function Aw(D,E){var F=this.dialect.block,B=F.__order__;if("__call__" in F){return F.__call__.call(this,D,E)}for(var A=0;A<B.length;A++){var C=F[B[A]].call(this,D,E);if(C){if(!AA(C)||(C.length>0&&!(AA(C[0])))){this.debug(B[A],"didn't return a proper array")}return C}}return[]};Ao.prototype.processInline=function AD(A){return this.dialect.inline.__call__.call(this,String(A))};Ao.prototype.toTree=function Az(B,E){var A=B instanceof Array?B:this.split_blocks(B);var C=this.tree;try{this.tree=E||this.tree||["markdown"];A:while(A.length){var D=this.processBlock(A.shift(),A);if(!D.length){continue A}this.tree.push.apply(this.tree,D)}return this.tree}finally{if(E){this.tree=C}}};Ao.prototype.debug=function(){var A=Array.prototype.slice.call(arguments);A.unshift(this.debug_indent);if(typeof print!=="undefined"){print.apply(print,A)}if(typeof console!=="undefined"&&typeof console.log!=="undefined"){console.log.apply(null,A)}};Ao.prototype.loop_re_over_block=function(B,C,A){var D,E=C.valueOf();while(E.length&&(D=B.exec(E))!=null){E=E.substr(D[0].length);A.call(this,D)}return E};Ao.dialects={};Ao.dialects.Gruber={block:{atxHeader:function y(D,B){var C=D.match(/^(#{1,6})\s*(.*?)\s*#*\s*(?:\n|$)/);if(!C){return undefined}var A=["header",{level:C[1].length}];Array.prototype.push.apply(A,this.processInline(C[2]));if(C[0].length<D.length){B.unshift(Af(D.substr(C[0].length),D.trailing,D.lineNumber+2))}return[A]},setextHeader:function x(C,D){var E=C.match(/^(.*)\n([-=])\2\2+(?:\n|$)/);if(!E){return undefined}var B=(E[2]==="=")?1:2;var A=["header",{level:B},E[1]];if(E[0].length<C.length){D.unshift(Af(C.substr(E[0].length),C.trailing,C.lineNumber+2))}return[A]},code:function r(D,B){var E=[],A=/^(?: {0,3}\t| {4})(.*)\n?/,C;if(!D.match(A)){return undefined}block_search:do{var F=this.loop_re_over_block(A,D.valueOf(),function(G){E.push(G[1])});if(F.length){B.unshift(Af(F,D.trailing));break block_search}else{if(B.length){if(!B[0].match(A)){break block_search}E.push(D.trailing.replace(/[^\n]/g,"").substring(2));D=B.shift()}else{break block_search}}}while(true);return[["code_block",E.join("\n")]]},horizRule:function v(D,B){var C=D.match(/^(?:([\s\S]*?)\n)?[ \t]*([-_*])(?:[ \t]*\2){2,}[ \t]*(?:\n([\s\S]*))?$/);if(!C){return undefined}var A=[["hr"]];if(C[1]){A.unshift.apply(A,this.processBlock(C[1],[]))}if(C[3]){B.unshift(Af(C[3]))}return A},lists:(function(){var B="[*+-]|\\d+\\.",F=/[*+-]/,D=/\d+\./,E=new RegExp("^( {0,3})("+B+")[ \t]+"),I="(?: {0,3}\\t| {4})";function A(K){return new RegExp("(?:^("+I+"{0,"+K+"} {0,3})("+B+")\\s+)|(^"+I+"{0,"+(K-1)+"}[ ]{0,4})")}function G(K){return K.replace(/ {0,3}\t/g,"    ")}function H(P,N,R,L){if(N){P.push(["para"].concat(R));return}var K=P[P.length-1] instanceof Array&&P[P.length-1][0]=="para"?P[P.length-1]:P;if(L&&P.length>1){R.unshift(L)}for(var M=0;M<R.length;M++){var O=R[M],Q=typeof O=="string";if(Q&&K.length>1&&typeof K[K.length-1]=="string"){K[K.length-1]+=O}else{K.push(O)}}}function C(N,L){var K=new RegExp("^("+I+"{"+N+"}.*?\\n?)*$"),Q=new RegExp("^"+I+"{"+N+"}","gm"),O=[];while(L.length>0){if(K.exec(L[0])){var M=L.shift(),P=M.replace(Q,"");O.push(Af(P,M.trailing,M.lineNumber))}break}return O}function J(N,L,K){var O=N.list;var P=O[O.length-1];if(P[1] instanceof Array&&P[1][0]=="para"){return}if(L+1==K.length){P.push(["para"].concat(P.splice(1)))}else{var M=P.pop();P.push(["para"].concat(P.splice(1)),M)}}return function(O,Y){var c=O.match(E);if(!c){return undefined}function N(h){var g=F.exec(h[2])?["bulletlist"]:["numberlist"];K.push({list:g,indent:h[1]});return g}var K=[],U=N(c),M,P=false,S=[K[0].list],d;loose_search:while(true){var L=O.split(/(?=\n)/);var f="";tight_search:for(var V=0;V<L.length;V++){var X="",Q=L[V].replace(/^\n/,function(g){X=g;return""});var b=A(K.length);c=Q.match(b);if(c[1]!==undefined){if(f.length){H(M,P,this.processInline(f),X);P=false;f=""}c[1]=G(c[1]);var R=Math.floor(c[1].length/4)+1;if(R>K.length){U=N(c);M.push(U);M=U[1]=["listitem"]}else{var e=false;for(d=0;d<K.length;d++){if(K[d].indent!=c[1]){continue}U=K[d].list;K.splice(d+1);e=true;break}if(!e){R++;if(R<=K.length){K.splice(R);U=K[R-1].list}else{U=N(c);M.push(U)}}M=["listitem"];U.push(M)}X=""}if(Q.length>c[0].length){f+=X+Q.substr(c[0].length)}}if(f.length){H(M,P,this.processInline(f),X);P=false;f=""}var T=C(K.length,Y);if(T.length>0){Aa(K,J,this);M.push.apply(M,this.toTree(T,[]))}var Z=Y[0]&&Y[0].valueOf()||"";if(Z.match(E)||Z.match(/^ /)){O=Y.shift();var W=this.dialect.block.horizRule(O,Y);if(W){S.push.apply(S,W);break}Aa(K,J,this);P=true;continue loose_search}break}return S}})(),blockquote:function Aj(E,G){if(!E.match(/^>/m)){return undefined}var H=[];if(E[0]!=">"){var B=E.split(/\n/),A=[];while(B.length&&B[0][0]!=">"){A.push(B.shift())}E=B.join("\n");H.push.apply(H,this.processBlock(A.join("\n"),[]))}while(G.length&&G[0][0]==">"){var F=G.shift();E=new String(E+E.trailing+F);E.trailing=F.trailing}var C=E.replace(/^> ?/gm,""),D=this.tree;H.push(this.toTree(C,["blockquote"]));return H},referenceDefn:function Ai(C,B){var A=/^\s*\[(.*?)\]:\s*(\S+)(?:\s+(?:(['"])(.*?)\3|\((.*?)\)))?\n?/;if(!C.match(A)){return undefined}if(!Ar(this.tree)){this.tree.splice(1,0,{})}var D=Ar(this.tree);if(D.references===undefined){D.references={}}var E=this.loop_re_over_block(A,C,function(F){if(F[2]&&F[2][0]=="<"&&F[2][F[2].length-1]==">"){F[2]=F[2].substring(1,F[2].length-1)}var G=D.references[F[1].toLowerCase()]={href:F[2]};if(F[4]!==undefined){G.title=F[4]}else{if(F[5]!==undefined){G.title=F[5]}}});if(E.length){B.unshift(Af(E,C.trailing))}return[]},para:function An(B,A){return[["para"].concat(this.processInline(B))]}}};Ao.dialects.Gruber.inline={__oneElement__:function Ah(F,C,E){var D,G,A=0;C=C||this.dialect.inline.__patterns__;var B=new RegExp("([\\s\\S]*?)("+(C.source||C)+")");D=B.exec(F);if(!D){return[F.length,F]}else{if(D[1]){return[D[1].length,D[1]]}}var G;if(D[2] in this.dialect.inline){G=this.dialect.inline[D[2]].call(this,F.substr(D.index),D,E||[])}G=G||[D[2].length,D[2]];return G},__call__:function At(B,C){var D=[],E;function A(F){if(typeof F=="string"&&typeof D[D.length-1]=="string"){D[D.length-1]+=F}else{D.push(F)}}while(B.length>0){E=this.dialect.inline.__oneElement__.call(this,B,C,D);B=B.substr(E.shift());Aa(E,A)}return D},"]":function(){},"}":function(){},"\\":function Am(A){if(A.match(/^\\[\\`\*_{}\[\]()#\+.!\-]/)){return[2,A[1]]}else{return[1,"\\"]}},"![":function Ae(B){var C=B.match(/^!\[(.*?)\][ \t]*\([ \t]*(\S*)(?:[ \t]+(["'])(.*?)\3)?[ \t]*\)/);if(C){if(C[2]&&C[2][0]=="<"&&C[2][C[2].length-1]==">"){C[2]=C[2].substring(1,C[2].length-1)}C[2]=this.dialect.inline.__call__.call(this,C[2],/\\/)[0];var A={alt:C[1],href:C[2]||""};if(C[4]!==undefined){A.title=C[4]}return[C[0].length,["img",A]]}C=B.match(/^!\[(.*?)\][ \t]*\[(.*?)\]/);if(C){return[C[0].length,["img_ref",{alt:C[1],ref:C[2].toLowerCase(),original:C[0]}]]}return[2,"!["]},"[":function u(E){var K=String(E);var H=Ao.DialectHelpers.inline_until_char.call(this,E.substr(1),"]");if(!H){return[1,"["]}var I=1+H[0],G=H[1],B,F;E=E.substr(I);var A=E.match(/^\s*\([ \t]*(\S+)(?:[ \t]+(["'])(.*?)\2)?[ \t]*\)/);if(A){var J=A[1];I+=A[0].length;if(J&&J[0]=="<"&&J[J.length-1]==">"){J=J.substring(1,J.length-1)}if(!A[3]){var D=1;for(var C=0;C<J.length;C++){switch(J[C]){case"(":D++;break;case")":if(--D==0){I-=J.length-C;J=J.substring(0,C)}break}}}J=this.dialect.inline.__call__.call(this,J,/\\/)[0];F={href:J||""};if(A[3]!==undefined){F.title=A[3]}B=["link",F].concat(G);return[I,B]}A=E.match(/^\s*\[(.*?)\]/);if(A){I+=A[0].length;F={ref:(A[1]||String(G)).toLowerCase(),original:K.substr(0,I)};B=["link_ref",F].concat(G);return[I,B]}if(G.length==1&&typeof G[0]=="string"){F={ref:G[0].toLowerCase(),original:K.substr(0,I)};B=["link_ref",F,G[0]];return[I,B]}return[1,"["]},"<":function As(A){var B;if((B=A.match(/^<(?:((https?|ftp|mailto):[^>]+)|(.*?@.*?\.[a-zA-Z]+))>/))!=null){if(B[3]){return[B[0].length,["link",{href:"mailto:"+B[3]},B[3]]]}else{if(B[2]=="mailto"){return[B[0].length,["link",{href:B[1]},B[1].substr("mailto:".length)]]}else{return[B[0].length,["link",{href:B[1]},B[1]]]}}}return[1,"<"]},"`":function Ap(A){var B=A.match(/(`+)(([\s\S]*?)\1)/);if(B&&B[2]){return[B[1].length+B[2].length,["inlinecode",B[3]]]}else{return[1,"`"]}},"  \n":function AB(A){return[3,["linebreak"]]}};function Ad(A,B){var E=A+"_state",C=A=="strong"?"em_state":"strong_state";function D(F){this.len_after=F;this.name="close_"+B}return function(H,M){if(this[E][0]==B){this[E].shift();return[H.length,new D(H.length-B.length)]}else{var G=this[C].slice(),L=this[E].slice();this[E].unshift(B);var F=this.processInline(H.substr(B.length));var J=F[F.length-1];var K=this[E].shift();if(J instanceof D){F.pop();var I=H.length-J.len_after;return[I,[A].concat(F)]}else{this[C]=G;this[E]=L;return[B.length,B]}}}}Ao.dialects.Gruber.inline["**"]=Ad("strong","**");Ao.dialects.Gruber.inline["__"]=Ad("strong","__");Ao.dialects.Gruber.inline["*"]=Ad("em","*");Ao.dialects.Gruber.inline["_"]=Ad("em","_");Ao.buildBlockOrder=function(A){var C=[];for(var B in A){if(B=="__order__"||B=="__call__"){continue}C.push(B)}A.__order__=C};Ao.buildInlinePatterns=function(A){var C=[];for(var B in A){if(B.match(/^__.*__$/)){continue}var D=B.replace(/([\\.*+?|()\[\]{}])/g,"\\$1").replace(/\n/,"\\n");C.push(B.length==1?D:"(?:"+D+")")}C=C.join("|");A.__patterns__=C;var E=A.__call__;A.__call__=function(F,G){if(G!=undefined){return E.call(this,F,G)}else{return E.call(this,F,C)}}};Ao.DialectHelpers={};Ao.DialectHelpers.inline_until_char=function(A,E){var C=0,B=[];while(true){if(A[C]==E){C++;return[C,B]}if(C>=A.length){return null}var D=this.dialect.inline.__oneElement__.call(this,A.substr(C));C+=D[0];B.push.apply(B,D.slice(1))}};Ao.subclassDialect=function(B){function A(){}A.prototype=B.block;function C(){}C.prototype=B.inline;return{block:new A(),inline:new C()}};Ao.buildBlockOrder(Ao.dialects.Gruber.block);Ao.buildInlinePatterns(Ao.dialects.Gruber.inline);Ao.dialects.Maruku=Ao.subclassDialect(Ao.dialects.Gruber);Ao.dialects.Maruku.processMetaHash=function Ak(B){var E=Aq(B),C={};for(var A=0;A<E.length;++A){if(/^#/.test(E[A])){C.id=E[A].substring(1)}else{if(/^\./.test(E[A])){if(C["class"]){C["class"]=C["class"]+E[A].replace(/./," ")}else{C["class"]=E[A].substring(1)}}else{if(/\=/.test(E[A])){var D=E[A].split(/\=/);C[D[0]]=D[1]}}}}return C};function Aq(E){var B=E.split(""),A=[""],D=false;while(B.length){var C=B.shift();switch(C){case" ":if(D){A[A.length-1]+=C}else{A.push("")}break;case"'":case'"':D=!D;break;case"\\":C=B.shift();default:A[A.length-1]+=C;break}}return A}Ao.dialects.Maruku.block.document_meta=function AC(D,B){if(D.lineNumber>1){return undefined}if(!D.match(/^(?:\w+:.*\n)*\w+:.*$/)){return undefined}if(!Ar(this.tree)){this.tree.splice(1,0,{})}var E=D.split(/\n/);for(p in E){var F=E[p].match(/(\w+):\s*(.*)$/),A=F[1].toLowerCase(),C=F[2];this.tree[1][A]=C}return[]};Ao.dialects.Maruku.block.block_meta=function AF(E,G){var C=E.match(/(^|\n) {0,3}\{:\s*((?:\\\}|[^\}])*)\s*\}$/);if(!C){return undefined}var B=this.dialect.processMetaHash(C[2]);var H;if(C[1]===""){var F=this.tree[this.tree.length-1];H=Ar(F);if(typeof F==="string"){return undefined}if(!H){H={};F.splice(1,0,H)}for(a in B){H[a]=B[a]}return[]}var D=E.replace(/\n.*$/,""),A=this.processBlock(D,[]);H=Ar(A[0]);if(!H){H={};A[0].splice(1,0,H)}for(a in B){H[a]=B[a]}return A};Ao.dialects.Maruku.block.definition_list=function Au(C,H){var A=/^((?:[^\s:].*\n)+):\s+([\s\S]+)$/,E=["dl"],F;if((D=C.match(A))){var G=[C];while(H.length&&A.exec(H[0])){G.push(H.shift())}for(var I=0;I<G.length;++I){var D=G[I].match(A),B=D[1].replace(/\n$/,"").split(/\n/),J=D[2].split(/\n:\s+/);for(F=0;F<B.length;++F){E.push(["dt",B[F]])}for(F=0;F<J.length;++F){E.push(["dd"].concat(this.processInline(J[F].replace(/(\n)\s+/,"$1"))))}}}else{return undefined}return[E]};Ao.dialects.Maruku.inline["{:"]=function Ax(C,D,A){if(!A.length){return[2,"{:"]}var H=A[A.length-1];if(typeof H==="string"){return[2,"{:"]}var G=C.match(/^\{:\s*((?:\\\}|[^\}])*)\s*\}/);if(!G){return[2,"{:"]}var B=this.dialect.processMetaHash(G[1]),E=Ar(H);if(!E){E={};H.splice(1,0,E)}for(var F in B){E[F]=B[F]}return[G[0].length,""]};Ao.buildBlockOrder(Ao.dialects.Maruku.block);Ao.buildInlinePatterns(Ao.dialects.Maruku.inline);var AA=Array.isArray||function(A){return Object.prototype.toString.call(A)=="[object Array]"};var Aa;if(Array.prototype.forEach){Aa=function(C,A,B){return C.forEach(A,B)}}else{Aa=function(D,A,B){for(var C=0;C<D.length;C++){A.call(B||D,D[C],C,D)}}}function Ar(A){return AA(A)&&A.length>1&&typeof A[1]==="object"&&!(AA(A[1]))?A[1]:undefined}Av.renderJsonML=function(A,B){B=B||{};B.root=B.root||false;var C=[];if(B.root){C.push(Ac(A))}else{A.shift();if(A.length&&typeof A[0]==="object"&&!(A[0] instanceof Array)){A.shift()}while(A.length){C.push(Ac(A.shift()))}}return C.join("\n\n")};function s(A){return A.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Ac(B){if(typeof B==="string"){return s(B)}var A=B.shift(),E={},C=[];if(B.length&&typeof B[0]==="object"&&!(B[0] instanceof Array)){E=B.shift()}while(B.length){C.push(arguments.callee(B.shift()))}var F="";for(var D in E){F+=" "+D+'="'+s(E[D])+'"'}if(A=="img"||A=="br"||A=="hr"){return"<"+A+F+"/>"}else{return"<"+A+F+">"+C.join("")+"</"+A+">"}}function Ag(I,D,C){var F;C=C||{};var G=I.slice(0);if(typeof C.preprocessTreeNode==="function"){G=C.preprocessTreeNode(G,D)}var A=Ar(G);if(A){G[1]={};for(F in A){G[1][F]=A[F]}A=G[1]}if(typeof G==="string"){return G}switch(G[0]){case"header":G[0]="h"+G[1].level;delete G[1].level;break;case"bulletlist":G[0]="ul";break;case"numberlist":G[0]="ol";break;case"listitem":G[0]="li";break;case"para":G[0]="p";break;case"markdown":G[0]="html";if(A){delete A.references}break;case"code_block":G[0]="pre";F=A?2:1;var E=["code"];E.push.apply(E,G.splice(F));G[F]=E;break;case"inlinecode":G[0]="code";break;case"img":G[1].src=G[1].href;delete G[1].href;break;case"linebreak":G[0]="br";break;case"link":G[0]="a";break;case"link_ref":G[0]="a";var B=D[A.ref];if(B){delete A.ref;A.href=B.href;if(B.title){A.title=B.title}delete A.original}else{return A.original}break;case"img_ref":G[0]="img";var B=D[A.ref];if(B){delete A.ref;A.src=B.href;if(B.title){A.title=B.title}delete A.original}else{return A.original}break}F=1;if(A){for(var H in G[1]){F=2}if(F===1){G.splice(F,1)}}for(;F<G.length;++F){G[F]=arguments.callee(G[F],D,C)}return G}function Ay(B){var A=Ar(B)?2:1;while(A<B.length){if(typeof B[A]==="string"){if(A+1<B.length&&typeof B[A+1]==="string"){B[A]+=B.splice(A+1,1)[0]}else{++A}}else{arguments.callee(B[A]);++A}}}})((function(){if(typeof exports==="undefined"){window.markdown={};return window.markdown}else{return exports}})());