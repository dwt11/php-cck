(function(D,C){if(typeof define==="function"&&define.amd){define("simple-uploader",["jquery","simple-module"],function(A,B){return(D.returnExportsGlobal=C(A,B))})}else{if(typeof exports==="object"){module.exports=C(require("jquery"),require("simple-module"))}else{D.simple=D.simple||{};D.simple["uploader"]=C(jQuery,SimpleModule)}}}(this,function(G,H){var J,K,I={}.hasOwnProperty,L=function(A,B){for(var C in B){if(I.call(B,C)){A[C]=B[C]}}function D(){this.constructor=A}D.prototype=B.prototype;A.prototype=new D();A.__super__=B.prototype;return A};J=(function(A){L(B,A);function B(){return B.__super__.constructor.apply(this,arguments)}B.count=0;B.prototype.opts={url:"",params:null,fileKey:"upload_file",connectionCount:3};B.prototype._init=function(){this.files=[];this.queue=[];this.id=++B.count;this.on("uploadcomplete",(function(C){return function(E,D){C.files.splice(G.inArray(D,C.files),1);if(C.queue.length>0&&C.files.length<C.opts.connectionCount){return C.upload(C.queue.shift())}else{return C.uploading=false}}})(this));return G(window).on("beforeunload.uploader-"+this.id,(function(C){return function(D){if(!C.uploading){return}D.originalEvent.returnValue=C._t("leaveConfirm");return C._t("leaveConfirm")}})(this))};B.prototype.generateId=(function(){var C;C=0;return function(){return C+=1}})();B.prototype.upload=function(O,P){var E,D,F,C;if(P==null){P={}}if(O==null){return}if(G.isArray(O)){for(F=0,C=O.length;F<C;F++){E=O[F];this.upload(E,P)}}else{if(G(O).is("input:file")){D=G(O).attr("name");if(D){P.fileKey=D}this.upload(G.makeArray(G(O)[0].files),P)}else{if(!O.id||!O.obj){O=this.getFile(O)}}}if(!(O&&O.obj)){return}G.extend(O,P);if(this.files.length>=this.opts.connectionCount){this.queue.push(O);return}if(this.triggerHandler("beforeupload",[O])===false){return}this.files.push(O);this._xhrUpload(O);return this.uploading=true};B.prototype.getFile=function(C){var F,E,D;if(C instanceof window.File||C instanceof window.Blob){F=(E=C.fileName)!=null?E:C.name}else{return null}return{id:this.generateId(),url:this.opts.url,params:this.opts.params,fileKey:this.opts.fileKey,name:F,size:(D=C.fileSize)!=null?D:C.size,ext:F?F.split(".").pop().toLowerCase():"",obj:C}};B.prototype._xhrUpload=function(E){var N,F,C,D;N=new FormData();N.append(E.fileKey,E.obj);N.append("original_filename",E.name);if(E.params){D=E.params;for(F in D){C=D[F];N.append(F,C)}}return E.xhr=G.ajax({url:E.url,data:N,dataType:"json",processData:false,contentType:false,type:"POST",headers:{"X-File-Name":encodeURIComponent(E.name)},xhr:function(){var M;M=G.ajaxSettings.xhr();if(M){M.upload.onprogress=(function(P){return function(O){return P.progress(O)}})(this)}return M},progress:(function(M){return function(P){if(!P.lengthComputable){return}return M.trigger("uploadprogress",[E,P.loaded,P.total])}})(this),error:(function(M){return function(S,R,T){return M.trigger("uploaderror",[E,S,R])}})(this),success:(function(M){return function(P){M.trigger("uploadprogress",[E,E.size,E.size]);return M.trigger("uploadsuccess",[E,P])}})(this),complete:(function(M){return function(R,Q){return M.trigger("uploadcomplete",[E,R.responseText])}})(this)})};B.prototype.cancel=function(E){var F,D,C,N;if(!E.id){N=this.files;for(D=0,C=N.length;D<C;D++){F=N[D];if(F.id===E*1){E=F;break}}}this.trigger("uploadcancel",[E]);if(E.xhr){E.xhr.abort()}return E.xhr=null};B.prototype.readImageFile=function(E,D){var F,C;if(!G.isFunction(D)){return}C=new Image();C.onload=function(){return D(C)};C.onerror=function(){return D()};if(window.FileReader&&FileReader.prototype.readAsDataURL&&/^image/.test(E.type)){F=new FileReader();F.onload=function(N){return C.src=N.target.result};return F.readAsDataURL(E)}else{return D()}};B.prototype.destroy=function(){var C,D,E,F;this.queue.length=0;F=this.files;for(D=0,E=F.length;D<E;D++){C=F[D];this.cancel(C)}G(window).off(".uploader-"+this.id);return G(document).off(".uploader-"+this.id)};B.i18n={"zh-CN":{leaveConfirm:"正在上传文件，如果离开上传会自动取消"}};B.locale="zh-CN";return B})(H);K=function(A){return new J(A)};return K}));