(function(D,C){if(typeof define==="function"&&define.amd){define("simditor",["jquery","simple-module","simple-hotkeys","simple-uploader"],function(A,B,H,G){return(D.returnExportsGlobal=C(A,B,H,G))})}else{if(typeof exports==="object"){module.exports=C(require("jquery"),require("simple-module"),require("simple-hotkeys"),require("simple-uploader"))}else{D["Simditor"]=C(jQuery,SimpleModule,simple.hotkeys,simple.uploader)}}}(this,function(v,Af,t,Au){var Ab,Ah={}.hasOwnProperty,r=function(A,B){for(var D in B){if(Ah.call(B,D)){A[D]=B[D]}}function C(){this.constructor=A}C.prototype=B.prototype;A.prototype=new C();A.__super__=B.prototype;return A};Ab=(function(A){r(B,A);function B(){return B.__super__.constructor.apply(this,arguments)}B.pluginName="Selection";B.prototype._init=function(){this.editor=this._module;return this.sel=document.getSelection()};B.prototype.clear=function(){var C;try{return this.sel.removeAllRanges()}catch(D){C=D}};B.prototype.getRange=function(){if(!this.editor.inputManager.focused||!this.sel.rangeCount){return null}return this.sel.getRangeAt(0)};B.prototype.selectRange=function(C){this.clear();this.sel.addRange(C);if(!this.editor.inputManager.focused&&(this.editor.util.browser.firefox||this.editor.util.browser.msie)){this.editor.body.focus()}return C};B.prototype.rangeAtEndOf=function(F,D){var E,G,C;if(D==null){D=this.getRange()}if(!((D!=null)&&D.collapsed)){return}F=v(F)[0];E=D.endContainer;G=this.editor.util.getNodeLength(E);if(!(D.endOffset===G-1&&v(E).contents().last().is("br"))&&D.endOffset!==G){return false}if(F===E){return true}else{if(!v.contains(F,E)){return false}}C=true;v(E).parentsUntil(F).addBack().each((function(H){return function(L,I){var J,K;K=v(I).parent().contents().filter(function(){return !(this!==I&&this.nodeType===3&&!this.nodeValue)});J=K.last();if(!(J.get(0)===I||(J.is("br")&&J.prev().get(0)===I))){C=false;return false}}})(this));return C};B.prototype.rangeAtStartOf=function(D,C){var E,F;if(C==null){C=this.getRange()}if(!((C!=null)&&C.collapsed)){return}D=v(D)[0];F=C.startContainer;if(C.startOffset!==0){return false}if(D===F){return true}else{if(!v.contains(D,F)){return false}}E=true;v(F).parentsUntil(D).addBack().each((function(G){return function(I,J){var H;H=v(J).parent().contents().filter(function(){return !(this!==J&&this.nodeType===3&&!this.nodeValue)});if(H.first().get(0)!==J){return E=false}}})(this));return E};B.prototype.insertNode=function(C,D){if(D==null){D=this.getRange()}if(D==null){return}C=v(C)[0];D.insertNode(C);return this.setRangeAfter(C,D)};B.prototype.setRangeAfter=function(C,D){if(D==null){D=this.getRange()}if(D==null){return}C=v(C)[0];D.setEndAfter(C);D.collapse(false);return this.selectRange(D)};B.prototype.setRangeBefore=function(C,D){if(D==null){D=this.getRange()}if(D==null){return}C=v(C)[0];D.setEndBefore(C);D.collapse(false);return this.selectRange(D)};B.prototype.setRangeAtStartOf=function(C,D){if(D==null){D=this.getRange()}C=v(C).get(0);D.setEnd(C,0);D.collapse(false);return this.selectRange(D)};B.prototype.setRangeAtEndOf=function(C,I){var H,G,J,D,E,F;if(I==null){I=this.getRange()}G=v(C);C=G.get(0);if(G.is("pre")){J=G.contents();if(J.length>0){D=J.last();E=D.text();if(E.charAt(E.length-1)==="\n"){I.setEnd(D[0],this.editor.util.getNodeLength(D[0])-1)}else{I.setEnd(D[0],this.editor.util.getNodeLength(D[0]))}}else{I.setEnd(C,0)}}else{F=this.editor.util.getNodeLength(C);if(C.nodeType!==3&&F>0){H=v(C).contents().last();if(H.is("br")){F-=1}else{if(H[0].nodeType!==3&&this.editor.util.isEmptyNode(H)){H.append(this.editor.util.phBr);C=H[0];F=0}}}I.setEnd(C,F)}I.collapse(false);return this.selectRange(I)};B.prototype.deleteRangeContents=function(D){var C,E;if(D==null){D=this.getRange()}E=D.cloneRange();C=D.cloneRange();E.collapse(true);C.collapse(false);if(!D.collapsed&&this.rangeAtStartOf(this.editor.body,E)&&this.rangeAtEndOf(this.editor.body,C)){this.editor.body.empty();D.setStart(this.editor.body[0],0);D.collapse(true);this.selectRange(D)}else{D.deleteContents()}return D};B.prototype.breakBlockEl=function(C,D){var E;if(D==null){D=this.getRange()}E=v(C);if(!D.collapsed){return E}D.setStartBefore(E.get(0));if(D.collapsed){return E}return E.before(D.extractContents())};B.prototype.save=function(C){var D,E,F;if(C==null){C=this.getRange()}if(this._selectionSaved){return}E=C.cloneRange();E.collapse(false);F=v("<span/>").addClass("simditor-caret-start");D=v("<span/>").addClass("simditor-caret-end");E.insertNode(D[0]);C.insertNode(F[0]);this.clear();return this._selectionSaved=true};B.prototype.restore=function(){var C,D,E,I,H,F,G;if(!this._selectionSaved){return false}H=this.editor.body.find(".simditor-caret-start");C=this.editor.body.find(".simditor-caret-end");if(H.length&&C.length){F=H.parent();G=F.contents().index(H);D=C.parent();E=D.contents().index(C);if(F[0]===D[0]){E-=1}I=document.createRange();I.setStart(F.get(0),G);I.setEnd(D.get(0),E);H.remove();C.remove();this.selectRange(I)}else{H.remove();C.remove()}this._selectionSaved=false;return I};return B})(Af);var Aj,Ah={}.hasOwnProperty,r=function(A,B){for(var D in B){if(Ah.call(B,D)){A[D]=B[D]}}function C(){this.constructor=A}C.prototype=B.prototype;A.prototype=new C();A.__super__=B.prototype;return A},x=[].indexOf||function(B){for(var C=0,A=this.length;C<A;C++){if(C in this&&this[C]===B){return C}}return -1};Aj=(function(A){r(B,A);function B(){return B.__super__.constructor.apply(this,arguments)}B.pluginName="Formatter";B.prototype._init=function(){this.editor=this._module;this._allowedTags=["br","a","img","b","strong","i","u","font","p","ul","ol","li","blockquote","pre","h1","h2","h3","h4","hr"];this._allowedAttributes={img:["src","alt","width","height","data-image-src","data-image-size","data-image-name","data-non-image"],a:["href","target"],font:["color"],pre:["data-lang","class"],p:["data-indent"],h1:["data-indent"],h2:["data-indent"],h3:["data-indent"],h4:["data-indent"]};return this.editor.body.on("click","a",(function(C){return function(D){return false}})(this))};B.prototype.decorate=function(C){if(C==null){C=this.editor.body}return this.editor.trigger("decorate",[C])};B.prototype.undecorate=function(C){if(C==null){C=this.editor.body.clone()}this.editor.trigger("undecorate",[C]);return v.trim(C.html())};B.prototype.autolink=function(L){var H,G,N,F,D,E,K,M,C,J,I;if(L==null){L=this.editor.body}F=[];G=function(O){return O.contents().each(function(P,Q){var S,R;S=v(Q);if(S.is("a")||S.closest("a, pre",L).length){return}if(S.contents().length){return G(S)}else{if((R=S.text())&&/https?:\/\/|www\./ig.test(R)){return F.push(S)}}})};G(L);E=/(https?:\/\/|www\.)[\w\-\.\?&=\/#%:,@\!\+]+/ig;for(J=0,I=F.length;J<I;J++){H=F[J];M=H.text();K=[];D=null;N=0;while((D=E.exec(M))!==null){K.push(document.createTextNode(M.substring(N,D.index)));N=E.lastIndex;C=/^(http(s)?:\/\/|\/)/.test(D[0])?D[0]:"http://"+D[0];K.push(v('<a href="'+C+'" rel="nofollow"></a>').text(D[0])[0])}K.push(document.createTextNode(M.substring(N)));H.replaceWith(v(K))}return L};B.prototype.format=function(L){var K,M,G,H,D,J,C,E,F,I;if(L==null){L=this.editor.body}if(L.is(":empty")){L.append("<p>"+this.editor.util.phBr+"</p>");return L}F=L.contents();for(D=0,C=F.length;D<C;D++){G=F[D];this.cleanNode(G,true)}I=L.contents();for(J=0,E=I.length;J<E;J++){H=I[J];K=v(H);if(K.is("br")){if(typeof M!=="undefined"&&M!==null){M=null}K.remove()}else{if(this.editor.util.isBlockNode(H)){if(K.is("li")){if(M&&M.is("ul, ol")){M.append(H)}else{M=v("<ul/>").insertBefore(H);M.append(H)}}else{M=null}}else{if(!M||M.is("ul, ol")){M=v("<p/>").insertBefore(H)}M.append(H)}}}return L};B.prototype.cleanNode=function(U,G){var H,T,I,N,L,C,P,K,D,R,J,O,Q,S,F,E,M;T=v(U);if(!(T.length>0)){return}if(T[0].nodeType===3){R=T.text().replace(/(\r\n|\n|\r)/gm,"");if(R){J=document.createTextNode(R);T.replaceWith(J)}else{T.remove()}return}P=T.contents();K=T.is('[class^="simditor-"]');if(T.is(this._allowedTags.join(","))||K){if(T.is("a")&&(H=T.find("img")).length>0){T.replaceWith(H);T=H;P=null}if(T.is("img")&&T.hasClass("uploading")){T.remove()}if(!K){L=this._allowedAttributes[T[0].tagName.toLowerCase()];E=v.makeArray(T[0].attributes);for(O=0,S=E.length;O<S;O++){C=E[O];if(!((L!=null)&&(M=C.name,x.call(L,M)>=0))){T.removeAttr(C.name)}}}}else{if(T[0].nodeType===1&&!T.is(":empty")){if(T.is("div, article, dl, header, footer, tr")){T.append("<br/>");P.first().unwrap()}else{if(T.is("table")){I=v("<p/>");T.find("tr").each((function(V){return function(W,X){return I.append(v(X).text()+"<br/>")}})(this));T.replaceWith(I);P=null}else{if(T.is("thead, tfoot")){T.remove();P=null}else{if(T.is("th")){N=v("<td/>").append(T.contents());T.replaceWith(N)}else{P.first().unwrap()}}}}}else{T.remove();P=null}}if(G&&(P!=null)&&!T.is("pre")){for(Q=0,F=P.length;Q<F;Q++){D=P[Q];this.cleanNode(D,true)}}return null};B.prototype.clearHtml=function(E,D){var C,F,G;if(D==null){D=true}C=v("<div/>").append(E);F=C.contents();G="";F.each((function(H){return function(L,I){var J,K;if(I.nodeType===3){return G+=I.nodeValue}else{if(I.nodeType===1){J=v(I);K=J.contents();if(K.length>0){G+=H.clearHtml(K)}if(D&&L<F.length-1&&J.is("br, p, div, li, tr, pre, address, artticle, aside, dl, figcaption, footer, h1, h2, h3, h4, header")){return G+="\n"}}}}})(this));return G};B.prototype.beautify=function(C){var D;D=function(E){return !!(E.is("p")&&!E.text()&&E.children(":not(br)").length<1)};return C.each((function(E){return function(G,F){var H;H=v(F);if(H.is(':not(img, br, col, td, hr, [class^="simditor-"]):empty')){H.remove()}if(D(H)){H.remove()}return H.find(':not(img, br, col, td, hr, [class^="simditor-"]):empty').remove()}})(this))};return B})(Af);var Ao,Ah={}.hasOwnProperty,r=function(A,B){for(var D in B){if(Ah.call(B,D)){A[D]=B[D]}}function C(){this.constructor=A}C.prototype=B.prototype;A.prototype=new C();A.__super__=B.prototype;return A},x=[].indexOf||function(B){for(var C=0,A=this.length;C<A;C++){if(C in this&&this[C]===B){return C}}return -1};Ao=(function(A){r(B,A);function B(){return B.__super__.constructor.apply(this,arguments)}B.pluginName="InputManager";B.prototype.opts={pasteImage:false};B.prototype._modifierKeys=[16,17,18,91,93,224];B.prototype._arrowKeys=[37,38,39,40];B.prototype._init=function(){var C;this.editor=this._module;if(this.opts.pasteImage&&typeof this.opts.pasteImage!=="string"){this.opts.pasteImage="inline"}this._keystrokeHandlers={};this.hotkeys=t({el:this.editor.body});this._pasteArea=v("<div/>").css({width:"1px",height:"1px",overflow:"hidden",position:"fixed",right:"0",bottom:"100px"}).attr({tabIndex:"-1",contentEditable:true}).addClass("simditor-paste-area").appendTo(this.editor.el);this._cleanPasteArea=v("<textarea/>").css({width:"1px",height:"1px",overflow:"hidden",position:"fixed",right:"0",bottom:"101px"}).attr({tabIndex:"-1"}).addClass("simditor-clean-paste-area").appendTo(this.editor.el);v(document).on("selectionchange.simditor"+this.editor.id,(function(D){return function(E){if(!D.focused){return}if(D._selectionTimer){clearTimeout(D._selectionTimer);D._selectionTimer=null}return D._selectionTimer=setTimeout(function(){return D.editor.trigger("selectionchanged")},20)}})(this));this.editor.on("valuechanged",(function(D){return function(){if(!D.editor.util.closestBlockEl()&&D.focused){D.editor.selection.save();D.editor.formatter.format();D.editor.selection.restore()}D.editor.body.find("hr, pre, .simditor-table").each(function(E,G){var H,F;H=v(G);if(H.parent().is("blockquote")||H.parent()[0]===D.editor.body[0]){F=false;if(H.next().length===0){v("<p/>").append(D.editor.util.phBr).insertAfter(H);F=true}if(H.prev().length===0){v("<p/>").append(D.editor.util.phBr).insertBefore(H);F=true}if(F){return setTimeout(function(){return D.editor.trigger("valuechanged")},10)}}});D.editor.body.find("pre:empty").append(D.editor.util.phBr);if(!D.editor.util.supportSelectionChange&&D.focused){return D.editor.trigger("selectionchanged")}}})(this));this.editor.on("selectionchanged",(function(D){return function(E){return D.editor.undoManager.update()}})(this));this.editor.body.on("keydown",v.proxy(this._onKeyDown,this)).on("keypress",v.proxy(this._onKeyPress,this)).on("keyup",v.proxy(this._onKeyUp,this)).on("mouseup",v.proxy(this._onMouseUp,this)).on("focus",v.proxy(this._onFocus,this)).on("blur",v.proxy(this._onBlur,this)).on("paste",v.proxy(this._onPaste,this)).on("drop",v.proxy(this._onDrop,this));if(this.editor.util.browser.firefox){this.addShortcut("cmd+left",(function(D){return function(E){E.preventDefault();D.editor.selection.sel.modify("move","backward","lineboundary");return false}})(this));this.addShortcut("cmd+right",(function(D){return function(E){E.preventDefault();D.editor.selection.sel.modify("move","forward","lineboundary");return false}})(this));this.addShortcut("cmd+a",(function(D){return function(G){var F,H,E,I;F=D.editor.body.children();if(!(F.length>0)){return}H=F.first().get(0);E=F.last().get(0);I=document.createRange();I.setStart(H,0);I.setEnd(E,D.editor.util.getNodeLength(E));D.editor.selection.selectRange(I);return false}})(this))}C=this.editor.util.os.mac?"cmd+enter":"ctrl+enter";this.addShortcut(C,(function(D){return function(E){D.editor.el.closest("form").find("button:submit").click();return false}})(this));if(this.editor.textarea.attr("autofocus")){return setTimeout((function(D){return function(){return D.editor.focus()}})(this),0)}};B.prototype._onFocus=function(C){this.editor.el.addClass("focus").removeClass("error");this.focused=true;this.lastCaretPosition=null;return setTimeout((function(D){return function(){D.editor.triggerHandler("focus");return D.editor.trigger("selectionchanged")}})(this),0)};B.prototype._onBlur=function(C){var D;this.editor.el.removeClass("focus");this.editor.sync();this.focused=false;this.lastCaretPosition=(D=this.editor.undoManager.currentState())!=null?D.caret:void 0;return this.editor.triggerHandler("blur")};B.prototype._onMouseUp=function(C){if(!this.editor.util.supportSelectionChange){return setTimeout((function(D){return function(){return D.editor.trigger("selectionchanged")}})(this),0)}};B.prototype._onKeyDown=function(F){var H,C,E,G,D,I;if(this.editor.triggerHandler(F)===false){return false}if(this.hotkeys.respondTo(F)){return}if(F.which in this._keystrokeHandlers){E=typeof(G=this._keystrokeHandlers[F.which])["*"]==="function"?G["*"](F):void 0;if(E){this.editor.trigger("valuechanged");return false}this.editor.util.traverseUp((function(J){return function(K){var L,M;if(K.nodeType!==1){return}L=(M=J._keystrokeHandlers[F.which])!=null?M[K.tagName.toLowerCase()]:void 0;E=typeof L==="function"?L(F,v(K)):void 0;if(E===true||E===false){return false}}})(this));if(E){this.editor.trigger("valuechanged");return false}}if((D=F.which,x.call(this._modifierKeys,D)>=0)||(I=F.which,x.call(this._arrowKeys,I)>=0)){return}C=this.editor.util.metaKey(F);H=this.editor.util.closestBlockEl();if(C&&F.which===86){return}if(this.editor.util.browser.webkit&&F.which===8&&this.editor.selection.rangeAtStartOf(H)){setTimeout((function(J){return function(){var K;if(!J.focused){return}K=J.editor.util.closestBlockEl();J.editor.selection.save();J.editor.formatter.cleanNode(K,true);J.editor.selection.restore();return J.editor.trigger("valuechanged")}})(this),10);this.typing=true}else{if(this._typing){if(this._typing!==true){clearTimeout(this._typing)}this._typing=setTimeout((function(J){return function(){J.editor.trigger("valuechanged");return J._typing=false}})(this),200)}else{setTimeout((function(J){return function(){return J.editor.trigger("valuechanged")}})(this),10);this._typing=true}}return null};B.prototype._onKeyPress=function(C){if(this.editor.triggerHandler(C)===false){return false}};B.prototype._onKeyUp=function(D){var E,C;if(this.editor.triggerHandler(D)===false){return false}if(!this.editor.util.supportSelectionChange&&(C=D.which,x.call(this._arrowKeys,C)>=0)){this.editor.trigger("selectionchanged");return}if((D.which===8||D.which===46)&&this.editor.util.isEmptyNode(this.editor.body)){this.editor.body.empty();E=v("<p/>").append(this.editor.util.phBr).appendTo(this.editor.body);this.editor.selection.setRangeAtStartOf(E)}};B.prototype._onPaste=function(J){var F,C,G,E,I,D,H;if(this.editor.triggerHandler(J)===false){return false}I=this.editor.selection.deleteRangeContents();if(!I.collapsed){I.collapse(true)}F=this.editor.util.closestBlockEl();C=F.is("pre, table");if(J.originalEvent.clipboardData&&J.originalEvent.clipboardData.items&&J.originalEvent.clipboardData.items.length>0){E=J.originalEvent.clipboardData.items[0];if(/^image\//.test(E.type)&&!C){G=E.getAsFile();if(!((G!=null)&&this.opts.pasteImage)){return}if(!G.name){G.name="Clipboard Image.png"}D={};D[this.opts.pasteImage]=true;if((H=this.editor.uploader)!=null){H.upload(G,D)}return false}}this.editor.selection.save(I);if(C){this._cleanPasteArea.focus();if(this.editor.util.browser.firefox){J.preventDefault();this._cleanPasteArea.val(J.originalEvent.clipboardData.getData("text/plain"))}else{if(this.editor.util.browser.msie&&this.editor.util.browser.version===10){J.preventDefault();this._cleanPasteArea.val(window.clipboardData.getData("Text"))}}}else{this._pasteArea.focus();if(this.editor.util.browser.msie&&this.editor.util.browser.version===10){J.preventDefault();this._pasteArea.html(window.clipboardData.getData("Text"))}}return setTimeout((function(K){return function(){var Y,e,S,f,N,W,b,P,L,V,Z,O,T,M,U,d,g,Q,c,X,R,a;if(K._pasteArea.is(":empty")&&!K._cleanPasteArea.val()){L=null}else{if(C){L=K._cleanPasteArea.val()}else{L=v("<div/>").append(K._pasteArea.contents());L.find("table colgroup").remove();K.editor.formatter.format(L);K.editor.formatter.decorate(L);K.editor.formatter.beautify(L.children());L=L.contents()}}K._pasteArea.empty();K._cleanPasteArea.val("");I=K.editor.selection.restore();if(K.editor.triggerHandler("pasting",[L])===false){return}if(!L){return}else{if(C){if(F.is("table")){b=L.split("\n");N=b.pop();for(V=0,M=b.length;V<M;V++){W=b[V];K.editor.selection.insertNode(document.createTextNode(W));K.editor.selection.insertNode(v("<br/>"))}K.editor.selection.insertNode(document.createTextNode(N))}else{L=v("<div/>").text(L);X=L.contents();for(Z=0,U=X.length;Z<U;Z++){P=X[Z];K.editor.selection.insertNode(v(P)[0],I)}}}else{if(F.is(K.editor.body)){for(O=0,d=L.length;O<d;O++){P=L[O];K.editor.selection.insertNode(P,I)}}else{if(L.length<1){return}else{if(L.length===1){if(L.is("p")){S=L.contents();if(S.length===1&&S.is("img")){Y=S;if(/^data:image/.test(Y.attr("src"))){if(!K.opts.pasteImage){return}e=K.editor.util.dataURLtoBlob(Y.attr("src"));e.name="Clipboard Image.png";D={};D[K.opts.pasteImage]=true;if((R=K.editor.uploader)!=null){R.upload(e,D)}return}else{if(Y.is('img[src^="webkit-fake-url://"]')){return}}}for(T=0,g=S.length;T<g;T++){P=S[T];K.editor.selection.insertNode(P,I)}}else{if(F.is("p")&&K.editor.util.isEmptyNode(F)){F.replaceWith(L);K.editor.selection.setRangeAtEndOf(L,I)}else{if(L.is("ul, ol")){if(L.find("li").length===1){L=v("<div/>").text(L.text());a=L.contents();for(c=0,Q=a.length;c<Q;c++){P=a[c];K.editor.selection.insertNode(v(P)[0],I)}}else{if(F.is("li")){F.parent().after(L);K.editor.selection.setRangeAtEndOf(L,I)}else{F.after(L);K.editor.selection.setRangeAtEndOf(L,I)}}}else{F.after(L);K.editor.selection.setRangeAtEndOf(L,I)}}}}else{if(F.is("li")){F=F.parent()}if(K.editor.selection.rangeAtStartOf(F,I)){f="before"}else{if(K.editor.selection.rangeAtEndOf(F,I)){f="after"}else{K.editor.selection.breakBlockEl(F,I);f="before"}}F[f](L);K.editor.selection.setRangeAtEndOf(L.last(),I)}}}}}return K.editor.trigger("valuechanged")}})(this),10)};B.prototype._onDrop=function(C){if(this.editor.triggerHandler(C)===false){return false}return setTimeout((function(D){return function(){return D.editor.trigger("valuechanged")}})(this),0)};B.prototype.addKeystrokeHandler=function(C,D,E){if(!this._keystrokeHandlers[C]){this._keystrokeHandlers[C]={}}return this._keystrokeHandlers[C][D]=E};B.prototype.addShortcut=function(C,D){return this.hotkeys.add(C,v.proxy(D,this))};return B})(Af);var n,Ah={}.hasOwnProperty,r=function(A,B){for(var D in B){if(Ah.call(B,D)){A[D]=B[D]}}function C(){this.constructor=A}C.prototype=B.prototype;A.prototype=new C();A.__super__=B.prototype;return A};n=(function(B){r(A,B);function A(){return A.__super__.constructor.apply(this,arguments)}A.pluginName="Keystroke";A.prototype._init=function(){var C;this.editor=this._module;if(this.editor.util.browser.safari){this.editor.inputManager.addKeystrokeHandler("13","*",(function(D){return function(G){var F,E;if(!G.shiftKey){return}F=D.editor.util.closestBlockEl();if(F.is("pre")){return}E=v("<br/>");if(D.editor.selection.rangeAtEndOf(F)){D.editor.selection.insertNode(E);D.editor.selection.insertNode(v("<br/>"));D.editor.selection.setRangeBefore(E)}else{D.editor.selection.insertNode(E)}return true}})(this))}if(this.editor.util.browser.webkit||this.editor.util.browser.msie){C=(function(D){return function(E,F){var G;if(!D.editor.selection.rangeAtEndOf(F)){return}G=v("<p/>").append(D.editor.util.phBr).insertAfter(F);D.editor.selection.setRangeAtStartOf(G);return true}})(this);this.editor.inputManager.addKeystrokeHandler("13","h1",C);this.editor.inputManager.addKeystrokeHandler("13","h2",C);this.editor.inputManager.addKeystrokeHandler("13","h3",C);this.editor.inputManager.addKeystrokeHandler("13","h4",C);this.editor.inputManager.addKeystrokeHandler("13","h5",C);this.editor.inputManager.addKeystrokeHandler("13","h6",C)}this.editor.inputManager.addKeystrokeHandler("8","*",(function(D){return function(G){var F,E;E=D.editor.util.furthestBlockEl();F=E.prev();if(F.is("hr")&&D.editor.selection.rangeAtStartOf(E)){D.editor.selection.save();F.remove();D.editor.selection.restore();return true}}})(this));this.editor.inputManager.addKeystrokeHandler("9","*",(function(D){return function(F){var E;E=D.editor.toolbar.findButton("code");if(!(D.editor.opts.tabIndent||(E&&E.active))){return}if(F.shiftKey){D.editor.util.outdent()}else{D.editor.util.indent()}return true}})(this));this.editor.inputManager.addKeystrokeHandler("13","li",(function(D){return function(E,J){var F,G,I,H;F=J.clone();F.find("ul, ol").remove();if(!(D.editor.util.isEmptyNode(F)&&J.is(D.editor.util.closestBlockEl()))){return}G=J.parent();if(J.next("li").length>0){if(!D.editor.util.isEmptyNode(J)){return}if(G.parent("li").length>0){I=v("<li/>").append(D.editor.util.phBr).insertAfter(G.parent("li"));H=v("<"+G[0].tagName+"/>").append(J.nextAll("li"));I.append(H)}else{I=v("<p/>").append(D.editor.util.phBr).insertAfter(G);H=v("<"+G[0].tagName+"/>").append(J.nextAll("li"));I.after(H)}}else{if(G.parent("li").length>0){I=v("<li/>").insertAfter(G.parent("li"));if(J.contents().length>0){I.append(J.contents())}else{I.append(D.editor.util.phBr)}}else{I=v("<p/>").append(D.editor.util.phBr).insertAfter(G);if(J.children("ul, ol").length>0){I.after(J.children("ul, ol"))}}}if(J.prev("li").length){J.remove()}else{G.remove()}D.editor.selection.setRangeAtStartOf(I);return true}})(this));this.editor.inputManager.addKeystrokeHandler("13","pre",(function(D){return function(E,H){var G,F,I;E.preventDefault();if(E.shiftKey){G=v("<p/>").append(D.editor.util.phBr).insertAfter(H);D.editor.selection.setRangeAtStartOf(G);return true}I=D.editor.selection.getRange();F=null;I.deleteContents();if(!D.editor.util.browser.msie&&D.editor.selection.rangeAtEndOf(H)){F=document.createTextNode("\n\n");I.insertNode(F);I.setEnd(F,1)}else{F=document.createTextNode("\n");I.insertNode(F);I.setStartAfter(F)}I.collapse(false);D.editor.selection.selectRange(I);return true}})(this));this.editor.inputManager.addKeystrokeHandler("13","blockquote",(function(D){return function(G,F){var E,H;E=D.editor.util.closestBlockEl();if(!(E.is("p")&&!E.next().length&&D.editor.util.isEmptyNode(E))){return}F.after(E);H=document.createRange();D.editor.selection.setRangeAtStartOf(E,H);return true}})(this));this.editor.inputManager.addKeystrokeHandler("8","li",(function(D){return function(K,L){var G,E,I,J,H,M,N,F;E=L.children("ul, ol");H=L.prev("li");if(!(E.length>0&&H.length>0)){return false}F="";M=null;L.contents().each(function(O,P){if(P.nodeType===1&&/UL|OL/.test(P.nodeName)){return false}if(P.nodeType===1&&/BR/.test(P.nodeName)){return}if(P.nodeType===3&&P.nodeValue){F+=P.nodeValue}else{if(P.nodeType===1){F+=v(P).text()}}return M=v(P)});if(M&&F.length===1&&D.editor.util.browser.firefox&&!M.next("br").length){G=v(D.editor.util.phBr).insertAfter(M);M.remove();D.editor.selection.setRangeBefore(G);return true}else{if(F.length>0){return false}}N=document.createRange();J=H.children("ul, ol");if(J.length>0){I=v("<li/>").append(D.editor.util.phBr).appendTo(J);J.append(E.children("li"));L.remove();D.editor.selection.setRangeAtEndOf(I,N)}else{D.editor.selection.setRangeAtEndOf(H,N);H.append(E);L.remove();D.editor.selection.selectRange(N)}return true}})(this));this.editor.inputManager.addKeystrokeHandler("8","pre",(function(D){return function(E,H){var G,F,I;if(!D.editor.selection.rangeAtStartOf(H)){return}F=H.html().replace("\n","<br/>");G=v("<p/>").append(F||D.editor.util.phBr).insertAfter(H);H.remove();I=document.createRange();D.editor.selection.setRangeAtStartOf(G,I);return true}})(this));return this.editor.inputManager.addKeystrokeHandler("8","blockquote",(function(D){return function(G,F){var H,E;if(!D.editor.selection.rangeAtStartOf(F)){return}H=F.children().first().unwrap();E=document.createRange();D.editor.selection.setRangeAtStartOf(H,E);return true}})(this))};return A})(Af);var Ax,Ah={}.hasOwnProperty,r=function(A,B){for(var D in B){if(Ah.call(B,D)){A[D]=B[D]}}function C(){this.constructor=A}C.prototype=B.prototype;A.prototype=new C();A.__super__=B.prototype;return A};Ax=(function(A){r(B,A);function B(){return B.__super__.constructor.apply(this,arguments)}B.pluginName="UndoManager";B.prototype._index=-1;B.prototype._capacity=50;B.prototype._timer=null;B.prototype._init=function(){var C,D;this.editor=this._module;this._stack=[];if(this.editor.util.os.mac){D="cmd+z";C="shift+cmd+z"}else{if(this.editor.util.os.win){D="ctrl+z";C="ctrl+y"}else{D="ctrl+z";C="shift+ctrl+z"}}this.editor.inputManager.addShortcut(D,(function(E){return function(F){F.preventDefault();E.undo();return false}})(this));this.editor.inputManager.addShortcut(C,(function(E){return function(F){F.preventDefault();E.redo();return false}})(this));return this.editor.on("valuechanged",(function(E){return function(F,G){if(G==="undo"){return}if(E._timer){clearTimeout(E._timer);E._timer=null}return E._timer=setTimeout(function(){E._pushUndoState();return E._timer=null},200)}})(this))};B.prototype._pushUndoState=function(){var C,D;if(this.editor.triggerHandler("pushundostate")===false){return}C=this.currentState();D=this.editor.body.html();if(C&&C.html===D){return}this._index+=1;this._stack.length=this._index;this._stack.push({html:D,caret:this.caretPosition()});if(this._stack.length>this._capacity){this._stack.shift();return this._index-=1}};B.prototype.currentState=function(){if(this._stack.length&&this._index>-1){return this._stack[this._index]}else{return null}};B.prototype.undo=function(){var C;if(this._index<1||this._stack.length<2){return}this.editor.hidePopover();this._index-=1;C=this._stack[this._index];this.editor.body.html(C.html);this.caretPosition(C.caret);this.editor.body.find(".selected").removeClass("selected");this.editor.sync();return this.editor.trigger("valuechanged",["undo"])};B.prototype.redo=function(){var C;if(this._index<0||this._stack.length<this._index+2){return}this.editor.hidePopover();this._index+=1;C=this._stack[this._index];this.editor.body.html(C.html);this.caretPosition(C.caret);this.editor.body.find(".selected").removeClass("selected");this.editor.sync();return this.editor.trigger("valuechanged",["undo"])};B.prototype.update=function(){var C,D;if(this._timer){return}C=this.currentState();if(!C){return}D=this.editor.body.html();C.html=D;return C.caret=this.caretPosition()};B.prototype._getNodeOffset=function(C,D){var E,F,G;if(D){E=v(C)}else{E=v(C).parent()}G=0;F=false;E.contents().each((function(H){return function(J,I){if(D===J||C===I){return false}if(I.nodeType===3){if(!F){G+=1;F=true}}else{G+=1;F=false}return null}})(this));return G};B.prototype._getNodePosition=function(E,D){var C,F;if(E.nodeType===3){F=E.previousSibling;while(F&&F.nodeType===3){E=F;D+=this.editor.util.getNodeLength(F);F=F.previousSibling}}else{D=this._getNodeOffset(E,D)}C=[];C.unshift(D);this.editor.util.traverseUp((function(G){return function(H){return C.unshift(G._getNodeOffset(H))}})(this),E);return C};B.prototype._getNodeByPosition=function(J){var G,E,D,I,K,C,F,H;I=this.editor.body[0];H=J.slice(0,J.length-1);for(D=C=0,F=H.length;C<F;D=++C){K=H[D];E=I.childNodes;if(K>E.length-1){if(D===J.length-2&&v(I).is("pre")){G=document.createTextNode("");I.appendChild(G);E=I.childNodes}else{I=null;break}}I=E[K]}return I};B.prototype.caretPosition=function(C){var D,E,H,F,G;if(!C){H=this.editor.selection.getRange();if(!(this.editor.inputManager.focused&&(H!=null))){return{}}C={start:[],end:null,collapsed:true};C.start=this._getNodePosition(H.startContainer,H.startOffset);if(!H.collapsed){C.end=this._getNodePosition(H.endContainer,H.endOffset);C.collapsed=false}return C}else{if(!this.editor.inputManager.focused){this.editor.body.focus()}if(!C.start){this.editor.body.blur();return}F=this._getNodeByPosition(C.start);G=C.start[C.start.length-1];if(C.collapsed){D=F;E=G}else{D=this._getNodeByPosition(C.end);E=C.start[C.start.length-1]}if(!F||!D){throw new Error("simditor: invalid caret state");return}H=document.createRange();H.setStart(F,G);H.setEnd(D,E);return this.editor.selection.selectRange(H)}};return B})(Af);var Ae,Ah={}.hasOwnProperty,r=function(A,B){for(var D in B){if(Ah.call(B,D)){A[D]=B[D]}}function C(){this.constructor=A}C.prototype=B.prototype;A.prototype=new C();A.__super__=B.prototype;return A};Ae=(function(A){r(B,A);function B(){return B.__super__.constructor.apply(this,arguments)}B.pluginName="Util";B.prototype._init=function(){this.editor=this._module;if(this.browser.msie&&this.browser.version<11){return this.phBr=""}};B.prototype.phBr="<br/>";B.prototype.os=(function(){var C;C={};if(/Mac/.test(navigator.appVersion)){C.mac=true}else{if(/Linux/.test(navigator.appVersion)){C.linux=true}else{if(/Win/.test(navigator.appVersion)){C.win=true}else{if(/X11/.test(navigator.appVersion)){C.unix=true}}}}if(/Mobi/.test(navigator.appVersion)){C.mobile=true}return C})();B.prototype.browser=(function(){var F,G,J,K,H,E,C,D,I;H=navigator.userAgent;J=/(msie|trident)/i.test(H);F=/chrome|crios/i.test(H);K=/safari/i.test(H)&&!F;G=/firefox/i.test(H);if(J){return{msie:true,version:((E=H.match(/(msie |rv:)(\d+(\.\d+)?)/i))!=null?E[2]:void 0)*1}}else{if(F){return{webkit:true,chrome:true,version:((C=H.match(/(?:chrome|crios)\/(\d+(\.\d+)?)/i))!=null?C[1]:void 0)*1}}else{if(K){return{webkit:true,safari:true,version:((D=H.match(/version\/(\d+(\.\d+)?)/i))!=null?D[1]:void 0)*1}}else{if(G){return{mozilla:true,firefox:true,version:((I=H.match(/firefox\/(\d+(\.\d+)?)/i))!=null?I[1]:void 0)*1}}else{return{}}}}}})();B.prototype.supportSelectionChange=(function(){var C,D;D=document.onselectionchange;if(D!==void 0){try{document.onselectionchange=0;return document.onselectionchange===null}catch(E){C=E}finally{document.onselectionchange=D}}return false})();B.prototype.reflow=function(C){if(C==null){C=document}return v(C)[0].offsetHeight};B.prototype.metaKey=function(C){var D;D=/Mac/.test(navigator.userAgent);if(D){return C.metaKey}else{return C.ctrlKey}};B.prototype.isEmptyNode=function(C){var D;D=v(C);return D.is(":empty")||(!D.text()&&!D.find(":not(br, span, div)").length)};B.prototype.isBlockNode=function(C){C=v(C)[0];if(!C||C.nodeType===3){return false}return/^(div|p|ul|ol|li|blockquote|hr|pre|h1|h2|h3|h4|table)$/.test(C.nodeName.toLowerCase())};B.prototype.closestBlockEl=function(D){var E,F,C;if(D==null){C=this.editor.selection.getRange();D=C!=null?C.commonAncestorContainer:void 0}E=v(D);if(!E.length){return null}F=E.parentsUntil(this.editor.body).addBack();F=F.filter((function(G){return function(H){return G.isBlockNode(F.eq(H))}})(this));if(F.length){return F.last()}else{return null}};B.prototype.furthestNode=function(E,F){var C,G,D;if(E==null){D=this.editor.selection.getRange();E=D!=null?D.commonAncestorContainer:void 0}C=v(E);if(!C.length){return null}G=C.parentsUntil(this.editor.body).addBack();G=G.filter((function(H){return function(J){var I;I=G.eq(J);if(v.isFunction(F)){return F(I)}else{return I.is(F)}}})(this));if(G.length){return G.first()}else{return null}};B.prototype.furthestBlockEl=function(C){return this.furthestNode(C,this.isBlockNode)};B.prototype.getNodeLength=function(C){switch(C.nodeType){case 7:case 10:return 0;case 3:case 8:return C.length;default:return C.childNodes.length}};B.prototype.traverseUp=function(E,I){var D,H,G,K,C,F,J;if(I==null){G=this.editor.selection.getRange();I=G!=null?G.commonAncestorContainer:void 0}if((I==null)||!v.contains(this.editor.body[0],I)){return false}H=v(I).parentsUntil(this.editor.body).get();H.unshift(I);J=[];for(C=0,F=H.length;C<F;C++){D=H[C];K=E(D);if(K===false){break}else{J.push(void 0)}}return J};B.prototype.indent=function(){var F,K,C,D,E,I,G,J,H,L;F=this.editor.util.closestBlockEl();if(!(F&&F.length>0)){return false}if(F.is("pre")){J=document.createTextNode("\u00A0\u00A0");this.editor.selection.insertNode(J)}else{if(F.is("li")){D=F.prev("li");if(D.length<1){return false}this.editor.selection.save();H=F.parent()[0].tagName;K=D.children("ul, ol");if(K.length>0){K.append(F)}else{v("<"+H+"/>").append(F).appendTo(D)}this.editor.selection.restore()}else{if(F.is("p, h1, h2, h3, h4")){I=(L=F.attr("data-indent"))!=null?L:0;I=I*1+1;if(I>10){I=10}F.attr("data-indent",I)}else{if(F.is("table")){G=this.editor.selection.getRange();E=v(G.commonAncestorContainer).closest("td");C=E.next("td");if(!(C.length>0)){C=E.parent("tr").next("tr").find("td:first")}if(!(E.length>0&&C.length>0)){return false}this.editor.selection.setRangeAtEndOf(C)}else{J=document.createTextNode("\u00A0\u00A0\u00A0\u00A0");this.editor.selection.insertNode(J)}}}}this.editor.trigger("valuechanged");return true};B.prototype.outdent=function(){var F,K,D,G,E,C,I,J,H;F=this.editor.util.closestBlockEl();if(!(F&&F.length>0)){return false}if(F.is("pre")){return false}else{if(F.is("li")){K=F.parent();D=K.parent("li");if(D.length<1){C=this.editor.toolbar.findButton(K[0].tagName.toLowerCase());if(C!=null){C.command()}return false}this.editor.selection.save();if(F.next("li").length>0){v("<"+K[0].tagName+"/>").append(F.nextAll("li")).appendTo(F)}F.insertAfter(D);if(K.children("li").length<1){K.remove()}this.editor.selection.restore()}else{if(F.is("p, h1, h2, h3, h4")){I=(H=F.attr("data-indent"))!=null?H:0;I=I*1-1;if(I<0){I=0}F.attr("data-indent",I)}else{if(F.is("table")){J=this.editor.selection.getRange();E=v(J.commonAncestorContainer).closest("td");G=E.prev("td");if(!(G.length>0)){G=E.parent("tr").prev("tr").find("td:last")}if(!(E.length>0&&G.length>0)){return false}this.editor.selection.setRangeAtEndOf(G)}else{return false}}}}this.editor.trigger("valuechanged");return true};B.prototype.dataURLtoBlob=function(K){var N,M,E,L,G,D,J,I,H,C,F;D=window.Blob&&(function(){var P;try{return Boolean(new Blob())}catch(O){P=O;return false}})();G=D&&window.Uint8Array&&(function(){var P;try{return new Blob([new Uint8Array(100)]).size===100}catch(O){P=O;return false}})();N=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder;if(!((D||N)&&window.atob&&window.ArrayBuffer&&window.Uint8Array)){return false}if(K.split(",")[0].indexOf("base64")>=0){L=atob(K.split(",")[1])}else{L=decodeURIComponent(K.split(",")[1])}M=new ArrayBuffer(L.length);I=new Uint8Array(M);for(J=C=0,F=L.length;0<=F?C<=F:C>=F;J=0<=F?++C:--C){I[J]=L.charCodeAt(J)}H=K.split(",")[0].split(":")[1].split(";")[0];if(D){return new Blob([G?I:M],{type:H})}E=new N();E.append(M);return E.getBlob(H)};return B})(Af);var o,Ah={}.hasOwnProperty,r=function(A,B){for(var D in B){if(Ah.call(B,D)){A[D]=B[D]}}function C(){this.constructor=A}C.prototype=B.prototype;A.prototype=new C();A.__super__=B.prototype;return A};o=(function(B){r(A,B);function A(){return A.__super__.constructor.apply(this,arguments)}A.pluginName="Toolbar";A.prototype.opts={toolbar:true,toolbarFloat:true,toolbarHidden:false,toolbarFloatOffset:0};A.prototype._tpl={wrapper:'<div class="simditor-toolbar"><ul></ul></div>',separator:'<li><span class="separator"></span></li>'};A.prototype._init=function(){var C;this.editor=this._module;if(!this.opts.toolbar){return}if(!v.isArray(this.opts.toolbar)){this.opts.toolbar=["bold","italic","underline","strikethrough","|","ol","ul","blockquote","code","|","link","image","|","indent","outdent"]}this._render();this.list.on("click",(function(D){return function(E){return false}})(this));this.wrapper.on("mousedown",(function(D){return function(E){return D.list.find(".menu-on").removeClass(".menu-on")}})(this));v(document).on("mousedown.simditor"+this.editor.id,(function(D){return function(E){return D.list.find(".menu-on").removeClass(".menu-on")}})(this));if(!this.opts.toolbarHidden&&this.opts.toolbarFloat){this.wrapper.width(this.wrapper.outerWidth());this.wrapper.css("top",this.opts.toolbarFloatOffset);C=this.wrapper.outerHeight();if(!this.editor.util.os.mobile){v(window).on("resize.simditor-"+this.editor.id,(function(D){return function(E){D.wrapper.css("position","static");D.editor.util.reflow(D.wrapper);D.wrapper.css("left",D.wrapper.offset().left);return D.wrapper.css("position","")}})(this)).resize()}v(window).on("scroll.simditor-"+this.editor.id,(function(D){return function(G){var F,E,H;H=D.editor.wrapper.offset().top;F=H+D.editor.wrapper.outerHeight()-80;E=v(document).scrollTop()+D.opts.toolbarFloatOffset;if(E<=H||E>=F){D.editor.wrapper.removeClass("toolbar-floating").css("padding-top","");if(D.editor.util.os.mobile){return D.wrapper.css("top",D.opts.toolbarFloatOffset)}}else{D.editor.wrapper.addClass("toolbar-floating").css("padding-top",C);if(D.editor.util.os.mobile){return D.wrapper.css("top",E-H+D.opts.toolbarFloatOffset)}}}})(this))}this.editor.on("selectionchanged",(function(D){return function(){return D.toolbarStatus()}})(this));this.editor.on("destroy",(function(D){return function(){return D.buttons.length=0}})(this));return v(document).on("mousedown.simditor-"+this.editor.id,(function(D){return function(E){return D.list.find("li.menu-on").removeClass("menu-on")}})(this))};A.prototype._render=function(){var E,D,C,F;this.buttons=[];this.wrapper=v(this._tpl.wrapper).prependTo(this.editor.wrapper);this.list=this.wrapper.find("ul");F=this.opts.toolbar;for(D=0,C=F.length;D<C;D++){E=F[D];if(E==="|"){v(this._tpl.separator).appendTo(this.list);continue}if(!this.constructor.buttons[E]){throw new Error('simditor: invalid toolbar button "'+E+'"');continue}this.buttons.push(new this.constructor.buttons[E]({editor:this.editor}))}if(this.opts.toolbarHidden){return this.wrapper.hide()}else{return this.editor.placeholderEl.css("top",this.wrapper.outerHeight())}};A.prototype.toolbarStatus=function(C){var D;if(!this.editor.inputManager.focused){return}D=this.buttons.slice(0);return this.editor.util.traverseUp((function(E){return function(I){var L,H,M,J,K,G,F;M=[];for(H=J=0,G=D.length;J<G;H=++J){L=D[H];if((C!=null)&&L.name!==C){continue}if(!L.status||L.status(v(I))===true){M.push(L)}}for(K=0,F=M.length;K<F;K++){L=M[K];H=v.inArray(L,D);D.splice(H,1)}if(D.length===0){return false}}})(this))};A.prototype.findButton=function(C){var D;D=this.list.find(".toolbar-item-"+C).data("button");return D!=null?D:null};A.addButton=function(C){return this.buttons[C.prototype.name]=C};A.buttons={};return A})(Af);var p,Ah={}.hasOwnProperty,r=function(A,B){for(var D in B){if(Ah.call(B,D)){A[D]=B[D]}}function C(){this.constructor=A}C.prototype=B.prototype;A.prototype=new C();A.__super__=B.prototype;return A};p=(function(B){r(A,B);function A(){return A.__super__.constructor.apply(this,arguments)}A.connect(Ae);A.connect(Ao);A.connect(Ax);A.connect(n);A.connect(Aj);A.connect(Ab);A.connect(o);A.count=0;A.prototype.opts={textarea:null,placeholder:"",defaultImage:"images/image.png",params:{},upload:false,tabIndent:true};A.prototype._init=function(){var E,D,F,C;this.textarea=v(this.opts.textarea);this.opts.placeholder=this.opts.placeholder||this.textarea.attr("placeholder");if(!this.textarea.length){throw new Error("simditor: param textarea is required.");return}D=this.textarea.data("simditor");if(D!=null){D.destroy()}this.id=++A.count;this._render();if(this.opts.upload&&Au){C=typeof this.opts.upload==="object"?this.opts.upload:{};this.uploader=Au(C)}F=this.textarea.closest("form");if(F.length){F.on("submit.simditor-"+this.id,(function(H){return function(){return H.sync()}})(this));F.on("reset.simditor-"+this.id,(function(H){return function(){return H.setValue("")}})(this))}this.on("initialized",(function(H){return function(){if(H.opts.placeholder){H.on("valuechanged",function(){return H._placeholder()})}return H.setValue(H.textarea.val().trim()||"")}})(this));if(this.util.browser.mozilla){this.util.reflow();try{document.execCommand("enableObjectResizing",false,false);return document.execCommand("enableInlineTableEditing",false,false)}catch(G){E=G}}};A.prototype._tpl='<div class="simditor">\n  <div class="simditor-wrapper">\n    <div class="simditor-placeholder"></div>\n    <div class="simditor-body" contenteditable="true">\n    </div>\n  </div>\n</div>';A.prototype._render=function(){var D,E,F,C;this.el=v(this._tpl).insertBefore(this.textarea);this.wrapper=this.el.find(".simditor-wrapper");this.body=this.wrapper.find(".simditor-body");this.placeholderEl=this.wrapper.find(".simditor-placeholder").append(this.opts.placeholder);this.el.append(this.textarea).data("simditor",this);this.textarea.data("simditor",this).hide().blur();this.body.attr("tabindex",this.textarea.attr("tabindex"));if(this.util.os.mac){this.el.addClass("simditor-mac")}else{if(this.util.os.linux){this.el.addClass("simditor-linux")}}if(this.util.os.mobile){this.el.addClass("simditor-mobile")}if(this.opts.params){F=this.opts.params;C=[];for(D in F){E=F[D];C.push(v("<input/>",{type:"hidden",name:D,value:E}).insertAfter(this.textarea))}return C}};A.prototype._placeholder=function(){var C,D;C=this.body.children();if(C.length===0||(C.length===1&&this.util.isEmptyNode(C)&&((D=C.data("indent"))!=null?D:0)<1)){return this.placeholderEl.show()}else{return this.placeholderEl.hide()}};A.prototype.setValue=function(C){this.hidePopover();this.textarea.val(C);this.body.html(C);this.formatter.format();this.formatter.decorate();this.util.reflow(this.body);this.inputManager.lastCaretPosition=null;return this.trigger("valuechanged")};A.prototype.getValue=function(){return this.sync()};A.prototype.sync=function(){var H,E,F,C,D,G;E=this.body.clone();this.formatter.undecorate(E);this.formatter.format(E);this.formatter.autolink(E);H=E.children();D=H.last("p");C=H.first("p");while(D.is("p")&&this.util.isEmptyNode(D)){F=D;D=D.prev("p");F.remove()}while(C.is("p")&&this.util.isEmptyNode(C)){F=C;C=D.next("p");F.remove()}E.find("img.uploading").remove();G=v.trim(E.html());this.textarea.val(G);return G};A.prototype.focus=function(){var C,D;if(this.inputManager.lastCaretPosition){return this.undoManager.caretPosition(this.inputManager.lastCaretPosition)}else{C=this.body.find("p, li, pre, h1, h2, h3, h4, td").first();if(!(C.length>0)){return}D=document.createRange();this.selection.setRangeAtStartOf(C,D);return this.body.focus()}};A.prototype.blur=function(){return this.body.blur()};A.prototype.hidePopover=function(){return this.el.find(".simditor-popover").each((function(C){return function(D,E){E=v(E).data("popover");if(E.active){return E.hide()}}})(this))};A.prototype.destroy=function(){this.triggerHandler("destroy");this.textarea.closest("form").off(".simditor .simditor-"+this.id);this.selection.clear();this.inputManager.focused=false;this.textarea.insertBefore(this.el).hide().val("").removeData("simditor");this.el.remove();v(document).off(".simditor-"+this.id);v(window).off(".simditor-"+this.id);return this.off()};return A})(Af);p.i18n={"zh-CN":{"blockquote":"引用","bold":"加粗文字","code":"插入代码","color":"文字颜色","hr":"分隔线","image":"插入图片","localImage":"本地图片","externalImage":"外链图片","uploadImage":"上传图片","uploadFailed":"上传失败了","uploadError":"上传出错了","imageUrl":"图片地址","imageSize":"图片尺寸","restoreImageSize":"还原图片尺寸","uploading":"正在上传","indent":"向右缩进","outdent":"向左缩进","italic":"斜体文字","link":"插入链接","text":"文本","linkText":"链接文字","linkUrl":"地址","removeLink":"移除链接","ol":"有序列表","ul":"无序列表","strikethrough":"删除线文字","table":"表格","deleteRow":"删除行","insertRowAbove":"在上面插入行","insertRowBelow":"在下面插入行","deleteColumn":"删除列","insertColumnLeft":"在左边插入列","insertColumnRight":"在右边插入列","deleteTable":"删除表格","title":"标题","normalText":"普通文本","underline":"下划线文字"}};var Ad,Ah={}.hasOwnProperty,r=function(A,B){for(var D in B){if(Ah.call(B,D)){A[D]=B[D]}}function C(){this.constructor=A}C.prototype=B.prototype;A.prototype=new C();A.__super__=B.prototype;return A},s=[].slice;Ad=(function(A){r(B,A);B.prototype._tpl={item:'<li><a tabindex="-1" unselectable="on" class="toolbar-item" href="javascript:;"><span></span></a></li>',menuWrapper:'<div class="toolbar-menu"></div>',menuItem:'<li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;"><span></span></a></li>',separator:'<li><span class="separator"></span></li>'};B.prototype.name="";B.prototype.icon="";B.prototype.title="";B.prototype.text="";B.prototype.htmlTag="";B.prototype.disableTag="";B.prototype.menu=false;B.prototype.active=false;B.prototype.disabled=false;B.prototype.needFocus=true;B.prototype.shortcut=null;function B(C){this.editor=C.editor;this.title=this._t(this.name);B.__super__.constructor.call(this,C)}B.prototype._init=function(){var E,F,D,G,C;this.render();this.el.on("mousedown",(function(H){return function(K){var I,J;K.preventDefault();if(H.el.hasClass("disabled")||(H.needFocus&&!H.editor.inputManager.focused)){return false}if(H.menu){H.wrapper.toggleClass("menu-on").siblings("li").removeClass("menu-on");if(H.wrapper.is(".menu-on")){I=H.menuWrapper.offset().left+H.menuWrapper.outerWidth()+5-H.editor.wrapper.offset().left-H.editor.wrapper.outerWidth();if(I>0){H.menuWrapper.css({"left":"auto","right":0})}H.trigger("menuexpand")}return false}J=H.el.data("param");H.command(J);return false}})(this));this.wrapper.on("click","a.menu-item",(function(H){return function(K){var J,I;K.preventDefault();J=v(K.currentTarget);H.wrapper.removeClass("menu-on");if(J.hasClass("disabled")||(H.needFocus&&!H.editor.inputManager.focused)){return false}H.editor.toolbar.wrapper.removeClass("menu-on");I=J.data("param");H.command(I);return false}})(this));this.wrapper.on("mousedown","a.menu-item",(function(H){return function(I){return false}})(this));this.editor.on("blur",(function(H){return function(){H.setActive(false);return H.setDisabled(false)}})(this));if(this.shortcut!=null){this.editor.inputManager.addShortcut(this.shortcut,(function(H){return function(I){H.el.mousedown();return false}})(this))}G=this.htmlTag.split(",");C=[];for(F=0,D=G.length;F<D;F++){E=G[F];E=v.trim(E);if(E&&v.inArray(E,this.editor.formatter._allowedTags)<0){C.push(this.editor.formatter._allowedTags.push(E))}else{C.push(void 0)}}return C};B.prototype.render=function(){this.wrapper=v(this._tpl.item).appendTo(this.editor.toolbar.list);this.el=this.wrapper.find("a.toolbar-item");this.el.attr("title",this.title).addClass("toolbar-item-"+this.name).data("button",this);this.el.find("span").addClass(this.icon?"fa fa-"+this.icon:"").text(this.text);if(!this.menu){return}this.menuWrapper=v(this._tpl.menuWrapper).appendTo(this.wrapper);this.menuWrapper.addClass("toolbar-menu-"+this.name);return this.renderMenu()};B.prototype.renderMenu=function(){var J,H,I,C,F,E,D,G;if(!v.isArray(this.menu)){return}this.menuEl=v("<ul/>").appendTo(this.menuWrapper);E=this.menu;G=[];for(C=0,F=E.length;C<F;C++){I=E[C];if(I==="|"){v(this._tpl.separator).appendTo(this.menuEl);continue}H=v(this._tpl.menuItem).appendTo(this.menuEl);G.push(J=H.find("a.menu-item").attr({"title":(D=I.title)!=null?D:I.text,"data-param":I.param}).addClass("menu-item-"+I.name).find("span").text(I.text))}return G};B.prototype.setActive=function(C){if(C===this.active){return}this.active=C;this.el.toggleClass("active",this.active);return this.editor.toolbar.trigger("buttonstatus",[this])};B.prototype.setDisabled=function(C){if(C===this.disabled){return}this.disabled=C;this.el.toggleClass("disabled",this.disabled);return this.editor.toolbar.trigger("buttonstatus",[this])};B.prototype.status=function(C){if(C!=null){this.setDisabled(C.is(this.disableTag))}if(this.disabled){return true}if(C!=null){this.setActive(C.is(this.htmlTag))}return this.active};B.prototype.command=function(C){};B.prototype._t=function(){var D,C,E;D=1<=arguments.length?s.call(arguments,0):[];C=B.__super__._t.apply(this,D);if(!C){C=(E=this.editor)._t.apply(E,D)}return C};return B})(Af);p.Button=Ad;var y,Ah={}.hasOwnProperty,r=function(A,B){for(var D in B){if(Ah.call(B,D)){A[D]=B[D]}}function C(){this.constructor=A}C.prototype=B.prototype;A.prototype=new C();A.__super__=B.prototype;return A};y=(function(A){r(B,A);B.prototype.offset={top:4,left:0};B.prototype.target=null;B.prototype.active=false;function B(C){this.button=C.button;this.editor=C.button.editor;B.__super__.constructor.call(this,C)}B.prototype._init=function(){this.el=v('<div class="simditor-popover"></div>').appendTo(this.editor.el).data("popover",this);this.render();this.el.on("mouseenter",(function(C){return function(D){return C.el.addClass("hover")}})(this));return this.el.on("mouseleave",(function(C){return function(D){return C.el.removeClass("hover")}})(this))};B.prototype.render=function(){};B.prototype.show=function(C,D){if(D==null){D="bottom"}if(C==null){return}this.el.siblings(".simditor-popover").each((function(E){return function(F,G){G=v(G).data("popover");if(G.active){return G.hide()}}})(this));this.target=C.addClass("selected");if(this.active){this.refresh(D);return this.trigger("popovershow")}else{this.active=true;this.el.css({left:-9999}).show();return setTimeout((function(E){return function(){E.refresh(D);return E.trigger("popovershow")}})(this),0)}};B.prototype.hide=function(){if(!this.active){return}if(this.target){this.target.removeClass("selected")}this.target=null;this.active=false;this.el.hide();return this.trigger("popoverhide")};B.prototype.refresh=function(C){var H,E,D,F,G;if(C==null){C="bottom"}if(!this.active){return}H=this.editor.el.offset();F=this.target.offset();D=this.target.outerHeight();if(C==="bottom"){G=F.top-H.top+D}else{if(C==="top"){G=F.top-H.top-this.el.height()}}E=Math.min(F.left-H.left,this.editor.wrapper.width()-this.el.outerWidth()-10);return this.el.css({top:G+this.offset.top,left:E+this.offset.left})};B.prototype.destroy=function(){this.target=null;this.active=false;this.editor.off(".linkpopover");return this.el.remove()};return B})(Af);p.Popover=y;var Ag,Ah={}.hasOwnProperty,r=function(A,B){for(var D in B){if(Ah.call(B,D)){A[D]=B[D]}}function C(){this.constructor=A}C.prototype=B.prototype;A.prototype=new C();A.__super__=B.prototype;return A};Ag=(function(B){r(A,B);function A(){return A.__super__.constructor.apply(this,arguments)}A.prototype.name="title";A.prototype.htmlTag="h1, h2, h3, h4";A.prototype.disableTag="pre, table";A.prototype._init=function(){this.menu=[{name:"normal",text:this._t("normalText"),param:"p"},"|",{name:"h1",text:this._t("title")+" 1",param:"h1"},{name:"h2",text:this._t("title")+" 2",param:"h2"},{name:"h3",text:this._t("title")+" 3",param:"h3"},{name:"h4",text:this._t("title")+" 4",param:"h4"},{name:"h5",text:this._t("title")+" 5",param:"h5"}];return A.__super__._init.call(this)};A.prototype.setActive=function(C,D){A.__super__.setActive.call(this,C);this.el.removeClass("active-p active-h1 active-h2 active-h3");if(C){return this.el.addClass("active active-"+D)}};A.prototype.status=function(C){var D,E;if(C!=null){this.setDisabled(C.is(this.disableTag))}if(this.disabled){return true}if(C!=null){D=(E=C[0].tagName)!=null?E.toLowerCase():void 0;this.setActive(C.is(this.htmlTag),D)}return this.active};A.prototype.command=function(I){var H,D,F,M,G,N,J,K,C,L,E;N=this.editor.selection.getRange();K=N.startContainer;M=N.endContainer;F=this.editor.util.closestBlockEl(K);D=this.editor.util.closestBlockEl(M);this.editor.selection.save();N.setStartBefore(F[0]);N.setEndAfter(D[0]);H=v(N.extractContents());J=[];H.children().each((function(O){return function(S,Q){var P,R,T,U,V;R=O._convertEl(Q,I);V=[];for(T=0,U=R.length;T<U;T++){P=R[T];V.push(J.push(P))}return V}})(this));E=J.reverse();for(C=0,L=E.length;C<L;C++){G=E[C];N.insertNode(G[0])}this.editor.selection.restore();return this.editor.trigger("valuechanged")};A.prototype._convertEl=function(E,F){var G,C,D;C=v(E);D=[];if(C.is(F)){D.push(C)}else{G=v("<"+F+"/>").append(C.contents());D.push(G)}return D};return A})(Ad);p.Toolbar.addButton(Ag);var q,Ah={}.hasOwnProperty,r=function(A,B){for(var D in B){if(Ah.call(B,D)){A[D]=B[D]}}function C(){this.constructor=A}C.prototype=B.prototype;A.prototype=new C();A.__super__=B.prototype;return A};q=(function(A){r(B,A);function B(){return B.__super__.constructor.apply(this,arguments)}B.prototype.name="bold";B.prototype.icon="bold";B.prototype.htmlTag="b, strong";B.prototype.disableTag="pre";B.prototype.shortcut="cmd+b";B.prototype._init=function(){if(this.editor.util.os.mac){this.title=this.title+" ( Cmd + b )"}else{this.title=this.title+" ( Ctrl + b )";this.shortcut="ctrl+b"}return B.__super__._init.call(this)};B.prototype.status=function(C){var D;if(C!=null){this.setDisabled(C.is(this.disableTag))}if(this.disabled){return true}D=document.queryCommandState("bold")===true;this.setActive(D);return D};B.prototype.command=function(){document.execCommand("bold");this.editor.trigger("valuechanged");return v(document).trigger("selectionchange")};return B})(Ad);p.Toolbar.addButton(q);var Av,Ah={}.hasOwnProperty,r=function(A,B){for(var D in B){if(Ah.call(B,D)){A[D]=B[D]}}function C(){this.constructor=A}C.prototype=B.prototype;A.prototype=new C();A.__super__=B.prototype;return A};Av=(function(A){r(B,A);function B(){return B.__super__.constructor.apply(this,arguments)}B.prototype.name="italic";B.prototype.icon="italic";B.prototype.htmlTag="i";B.prototype.disableTag="pre";B.prototype.shortcut="cmd+i";B.prototype._init=function(){if(this.editor.util.os.mac){this.title=this.title+" ( Cmd + i )"}else{this.title=this.title+" ( Ctrl + i )";this.shortcut="ctrl+i"}return B.__super__._init.call(this)};B.prototype.status=function(C){var D;if(C!=null){this.setDisabled(C.is(this.disableTag))}if(this.disabled){return this.disabled}D=document.queryCommandState("italic")===true;this.setActive(D);return D};B.prototype.command=function(){document.execCommand("italic");this.editor.trigger("valuechanged");return v(document).trigger("selectionchange")};return B})(Ad);p.Toolbar.addButton(Av);var Ar,Ah={}.hasOwnProperty,r=function(A,B){for(var D in B){if(Ah.call(B,D)){A[D]=B[D]}}function C(){this.constructor=A}C.prototype=B.prototype;A.prototype=new C();A.__super__=B.prototype;return A};Ar=(function(A){r(B,A);function B(){return B.__super__.constructor.apply(this,arguments)}B.prototype.name="underline";B.prototype.icon="underline";B.prototype.htmlTag="u";B.prototype.disableTag="pre";B.prototype.shortcut="cmd+u";B.prototype.render=function(){if(this.editor.util.os.mac){this.title=this.title+" ( Cmd + u )"}else{this.title=this.title+" ( Ctrl + u )";this.shortcut="ctrl+u"}return B.__super__.render.call(this)};B.prototype.status=function(C){var D;if(C!=null){this.setDisabled(C.is(this.disableTag))}if(this.disabled){return this.disabled}D=document.queryCommandState("underline")===true;this.setActive(D);return D};B.prototype.command=function(){document.execCommand("underline");this.editor.trigger("valuechanged");return v(document).trigger("selectionchange")};return B})(Ad);p.Toolbar.addButton(Ar);var u,Ah={}.hasOwnProperty,r=function(A,B){for(var D in B){if(Ah.call(B,D)){A[D]=B[D]}}function C(){this.constructor=A}C.prototype=B.prototype;A.prototype=new C();A.__super__=B.prototype;return A},s=[].slice;u=(function(A){r(B,A);function B(){return B.__super__.constructor.apply(this,arguments)}B.prototype.name="color";B.prototype.icon="font";B.prototype.disableTag="pre";B.prototype.menu=true;B.prototype.render=function(){var C;C=1<=arguments.length?s.call(arguments,0):[];return B.__super__.render.apply(this,C)};B.prototype.renderMenu=function(){v('<ul class="color-list">\n  <li><a href="javascript:;" class="font-color font-color-1" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-2" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-3" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-4" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-5" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-6" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-7" data-color=""></a></li>\n  <li><a href="javascript:;" class="font-color font-color-default" data-color=""></a></li>\n</ul>').appendTo(this.menuWrapper);this.menuWrapper.on("mousedown",".color-list",function(C){return false});return this.menuWrapper.on("click",".font-color",(function(C){return function(G){var H,F,D,E;C.wrapper.removeClass("menu-on");H=v(G.currentTarget);if(H.hasClass("font-color-default")){F=C.editor.body.find("p, li");if(!(F.length>0)){return}E=window.getComputedStyle(F[0],null).getPropertyValue("color");D=C._convertRgbToHex(E)}else{E=window.getComputedStyle(H[0],null).getPropertyValue("background-color");D=C._convertRgbToHex(E)}if(!D){return}document.execCommand("foreColor",false,D);return C.editor.trigger("valuechanged")}})(this))};B.prototype._convertRgbToHex=function(C){var E,D,F;D=/rgb\((\d+),\s?(\d+),\s?(\d+)\)/g;E=D.exec(C);if(!E){return""}F=function(I,G,H){var J;J=function(K){var L;L=K.toString(16);if(L.length===1){return"0"+L}else{return L}};return"#"+J(I)+J(G)+J(H)};return F(E[1]*1,E[2]*1,E[3]*1)};return B})(Ad);p.Toolbar.addButton(u);var Al,Aq,Aw,Ah={}.hasOwnProperty,r=function(A,B){for(var D in B){if(Ah.call(B,D)){A[D]=B[D]}}function C(){this.constructor=A}C.prototype=B.prototype;A.prototype=new C();A.__super__=B.prototype;return A};Al=(function(B){r(A,B);function A(){return A.__super__.constructor.apply(this,arguments)}A.prototype.type="";A.prototype.disableTag="pre, table";A.prototype.status=function(C){var D;if(C!=null){this.setDisabled(C.is(this.disableTag))}if(this.disabled){return true}if(C==null){return this.active}D=this.type==="ul"?"ol":"ul";if(C.is(D)){this.setActive(false);return true}else{this.setActive(C.is(this.htmlTag));return this.active}};A.prototype.command=function(Q){var L,G,T,F,C,M,S,I,P,N,E,H,K,O,D,J,R;E=this.editor.selection.getRange();O=E.startContainer;I=E.endContainer;M=this.editor.util.closestBlockEl(O);G=this.editor.util.closestBlockEl(I);this.editor.selection.save();E.setStartBefore(M[0]);E.setEndAfter(G[0]);if(M.is("li")&&G.is("li")){F=this.editor.util.furthestNode(M,"ul, ol");T=this.editor.util.furthestNode(G,"ul, ol");if(F.is(T)){P=function(V){var U;U=1;while(!V.parent().is(F)){U+=1;V=V.parent()}return U};K=P(M);S=P(G);if(K>S){C=G.parent()}else{C=M.parent()}E.setStartBefore(C[0]);E.setEndAfter(C[0])}else{E.setStartBefore(F[0]);E.setEndAfter(T[0])}}L=v(E.extractContents());H=[];L.children().each((function(U){return function(W,b){var a,V,Y,X,Z;V=U._convertEl(b);Z=[];for(Y=0,X=V.length;Y<X;Y++){a=V[Y];if(H.length&&H[H.length-1].is(U.type)&&a.is(U.type)){Z.push(H[H.length-1].append(a.children()))}else{Z.push(H.push(a))}}return Z}})(this));R=H.reverse();for(D=0,J=R.length;D<J;D++){N=R[D];E.insertNode(N[0])}this.editor.selection.restore();return this.editor.trigger("valuechanged")};A.prototype._convertEl=function(D){var L,J,I,H,C,G,K,F,E;L=v(D);G=[];J=this.type==="ul"?"ol":"ul";if(L.is(this.type)){L.children("li").each((function(M){return function(P,O){var Q,R,N;R=v(O);Q=R.children("ul, ol").remove();N=v("<p/>").append(v(O).html()||M.editor.util.phBr);G.push(N);if(Q.length>0){return G.push(Q)}}})(this))}else{if(L.is(J)){I=v("<"+this.type+"/>").append(L.html());G.push(I)}else{if(L.is("blockquote")){E=L.children().get();for(K=0,F=E.length;K<F;K++){H=E[K];C=this._convertEl(H)}v.merge(G,C)}else{if(L.is("table")){}else{I=v("<"+this.type+"><li></li></"+this.type+">");I.find("li").append(L.html()||this.editor.util.phBr);G.push(I)}}}}return G};return A})(Ad);Aq=(function(A){r(B,A);function B(){return B.__super__.constructor.apply(this,arguments)}B.prototype.type="ol";B.prototype.name="ol";B.prototype.icon="list-ol";B.prototype.htmlTag="ol";B.prototype.shortcut="cmd+/";B.prototype._init=function(){if(this.editor.util.os.mac){this.title=this.title+" ( Cmd + / )"}else{this.title=this.title+" ( ctrl + / )";this.shortcut="ctrl+/"}return B.__super__._init.call(this)};return B})(Al);Aw=(function(A){r(B,A);function B(){return B.__super__.constructor.apply(this,arguments)}B.prototype.type="ul";B.prototype.name="ul";B.prototype.icon="list-ul";B.prototype.htmlTag="ul";B.prototype.shortcut="cmd+.";B.prototype._init=function(){if(this.editor.util.os.mac){this.title=this.title+" ( Cmd + . )"}else{this.title=this.title+" ( Ctrl + . )";this.shortcut="ctrl+."}return B.__super__._init.call(this)};return B})(Al);p.Toolbar.addButton(Aq);p.Toolbar.addButton(Aw);var As,Ah={}.hasOwnProperty,r=function(A,B){for(var D in B){if(Ah.call(B,D)){A[D]=B[D]}}function C(){this.constructor=A}C.prototype=B.prototype;A.prototype=new C();A.__super__=B.prototype;return A};As=(function(B){r(A,B);function A(){return A.__super__.constructor.apply(this,arguments)}A.prototype.name="blockquote";A.prototype.icon="quote-left";A.prototype.htmlTag="blockquote";A.prototype.disableTag="pre, table";A.prototype.command=function(){var I,D,F,L,G,M,J,K,C,H,E;M=this.editor.selection.getRange();K=M.startContainer;L=M.endContainer;F=this.editor.util.furthestBlockEl(K);D=this.editor.util.furthestBlockEl(L);this.editor.selection.save();M.setStartBefore(F[0]);M.setEndAfter(D[0]);I=v(M.extractContents());J=[];I.children().each((function(N){return function(Q,O){var U,P,S,R,T;P=N._convertEl(O);T=[];for(S=0,R=P.length;S<R;S++){U=P[S];if(J.length&&J[J.length-1].is(N.htmlTag)&&U.is(N.htmlTag)){T.push(J[J.length-1].append(U.children()))}else{T.push(J.push(U))}}return T}})(this));E=J.reverse();for(C=0,H=E.length;C<H;C++){G=E[C];M.insertNode(G[0])}this.editor.selection.restore();return this.editor.trigger("valuechanged")};A.prototype._convertEl=function(D){var E,C,F;E=v(D);F=[];if(E.is(this.htmlTag)){E.children().each((function(G){return function(H,I){return F.push(v(I))}})(this))}else{C=v("<"+this.htmlTag+"/>").append(E);F.push(C)}return F};return A})(Ad);p.Toolbar.addButton(As);var Ac,w,Ah={}.hasOwnProperty,r=function(A,B){for(var D in B){if(Ah.call(B,D)){A[D]=B[D]}}function C(){this.constructor=A}C.prototype=B.prototype;A.prototype=new C();A.__super__=B.prototype;return A},s=[].slice;Ac=(function(A){r(B,A);function B(){return B.__super__.constructor.apply(this,arguments)}B.prototype.name="code";B.prototype.icon="code";B.prototype.htmlTag="pre";B.prototype.disableTag="li, table";B.prototype._init=function(){B.__super__._init.call(this);this.editor.on("decorate",(function(C){return function(D,E){return E.find("pre").each(function(F,G){return C.decorate(v(G))})}})(this));return this.editor.on("undecorate",(function(C){return function(D,E){return E.find("pre").each(function(F,G){return C.undecorate(v(G))})}})(this))};B.prototype.render=function(){var C;C=1<=arguments.length?s.call(arguments,0):[];B.__super__.render.apply(this,C);return this.popover=new w({button:this})};B.prototype.status=function(C){var D;D=B.__super__.status.call(this,C);if(this.active){this.popover.show(C)}else{if(this.editor.util.isBlockNode(C)){this.popover.hide()}}return D};B.prototype.decorate=function(C){var D;D=C.attr("data-lang");C.removeClass();if(D&&D!==-1){return C.addClass("lang-"+D)}};B.prototype.undecorate=function(C){var D;D=C.attr("data-lang");C.removeClass();if(D&&D!==-1){return C.addClass("lang-"+D)}};B.prototype.command=function(){var I,D,F,L,G,M,J,K,C,H,E;M=this.editor.selection.getRange();K=M.startContainer;L=M.endContainer;F=this.editor.util.closestBlockEl(K);D=this.editor.util.closestBlockEl(L);M.setStartBefore(F[0]);M.setEndAfter(D[0]);I=v(M.extractContents());J=[];I.children().each((function(N){return function(Q,O){var U,P,S,R,T;P=N._convertEl(O);T=[];for(S=0,R=P.length;S<R;S++){U=P[S];if(J.length&&J[J.length-1].is(N.htmlTag)&&U.is(N.htmlTag)){T.push(J[J.length-1].append(U.contents()))}else{T.push(J.push(U))}}return T}})(this));E=J.reverse();for(C=0,H=E.length;C<H;C++){G=E[C];M.insertNode(G[0])}this.editor.selection.setRangeAtEndOf(J[0]);return this.editor.trigger("valuechanged")};B.prototype._convertEl=function(E){var C,D,F,G;C=v(E);G=[];if(C.is(this.htmlTag)){D=v("<p/>").append(C.html().replace("\n","<br/>"));G.push(D)}else{if(!C.text()&&C.children().length===1&&C.children().is("br")){F="\n"}else{F=this.editor.formatter.clearHtml(C)}D=v("<"+this.htmlTag+"/>").text(F);G.push(D)}return G};return B})(Ad);w=(function(B){r(A,B);function A(){return A.__super__.constructor.apply(this,arguments)}A.prototype._tpl='<div class="code-settings">\n  <div class="settings-field">\n    <select class="select-lang">\n      <option value="-1">选择程序语言</option>\n      <option value="bash">Bash</option>\n      <option value="c++">C++</option>\n      <option value="cs">C#</option>\n      <option value="css">CSS</option>\n      <option value="erlang">Erlang</option>\n      <option value="less">Less</option>\n      <option value="scss">Sass</option>\n      <option value="diff">Diff</option>\n      <option value="coffeeScript">CoffeeScript</option>\n      <option value="html">Html,XML</option>\n      <option value="json">JSON</option>\n      <option value="java">Java</option>\n      <option value="js">JavaScript</option>\n      <option value="markdown">Markdown</option>\n      <option value="oc">Objective C</option>\n      <option value="php">PHP</option>\n      <option value="perl">Perl</option>\n      <option value="python">Python</option>\n      <option value="ruby">Ruby</option>\n      <option value="sql">SQL</option>\n    </select>\n  </div>\n</div>';A.prototype.render=function(){this.el.addClass("code-popover").append(this._tpl);this.selectEl=this.el.find(".select-lang");return this.selectEl.on("change",(function(C){return function(D){var E;C.lang=C.selectEl.val();E=C.target.hasClass("selected");C.target.removeClass().removeAttr("data-lang");if(C.lang!==-1){C.target.addClass("lang-"+C.lang);C.target.attr("data-lang",C.lang)}if(E){return C.target.addClass("selected")}}})(this))};A.prototype.show=function(){var C;C=1<=arguments.length?s.call(arguments,0):[];A.__super__.show.apply(this,C);this.lang=this.target.attr("data-lang");if(this.lang!=null){return this.selectEl.val(this.lang)}else{return this.selectEl.val(-1)}};return A})(y);p.Toolbar.addButton(Ac);var At,Ap,Ah={}.hasOwnProperty,r=function(A,B){for(var D in B){if(Ah.call(B,D)){A[D]=B[D]}}function C(){this.constructor=A}C.prototype=B.prototype;A.prototype=new C();A.__super__=B.prototype;return A},s=[].slice;At=(function(A){r(B,A);function B(){return B.__super__.constructor.apply(this,arguments)}B.prototype.name="link";B.prototype.icon="link";B.prototype.htmlTag="a";B.prototype.disableTag="pre";B.prototype.render=function(){var C;C=1<=arguments.length?s.call(arguments,0):[];B.__super__.render.apply(this,C);return this.popover=new Ap({button:this})};B.prototype.status=function(C){var D;if(C!=null){this.setDisabled(C.is(this.disableTag))}if(this.disabled){return true}if(C==null){return this.active}D=true;if(!C.is(this.htmlTag)||C.is('[class^="simditor-"]')){this.setActive(false);D=false}else{if(this.editor.selection.rangeAtEndOf(C)){this.setActive(true);D=false}else{this.setActive(true)}}if(D){this.popover.show(C)}else{if(this.editor.util.isBlockNode(C)){this.popover.hide()}}return this.active};B.prototype.command=function(){var I,E,K,D,F,H,C,L,J,G;L=this.editor.selection.getRange();if(this.active){K=v(L.commonAncestorContainer).closest("a");G=document.createTextNode(K.text());K.replaceWith(G);L.selectNode(G)}else{J=L.startContainer;H=L.endContainer;F=this.editor.util.closestBlockEl(J);E=this.editor.util.closestBlockEl(H);I=v(L.extractContents());C=this.editor.formatter.clearHtml(I.contents(),false);K=v("<a/>",{href:"http://www.example.com",target:"_blank",text:C||this._t("linkText")});if(F[0]===E[0]){L.insertNode(K[0])}else{D=v("<p/>").append(K);L.insertNode(D[0])}L.selectNodeContents(K[0]);this.popover.one("popovershow",(function(M){return function(){if(C){M.popover.urlEl.focus();return M.popover.urlEl[0].select()}else{M.popover.textEl.focus();return M.popover.textEl[0].select()}}})(this))}this.editor.selection.selectRange(L);return this.editor.trigger("valuechanged")};return B})(Ad);Ap=(function(A){r(B,A);function B(){return B.__super__.constructor.apply(this,arguments)}B.prototype.render=function(){var C;C='<div class="link-settings">\n  <div class="settings-field">\n    <label>'+(this._t("text"))+'</label>\n    <input class="link-text" type="text"/>\n    <a class="btn-unlink" href="javascript:;" title="'+(this._t("removeLink"))+'" tabindex="-1"><span class="fa fa-unlink"></span></a>\n  </div>\n  <div class="settings-field">\n    <label>'+(this._t("linkUrl"))+'</label>\n    <input class="link-url" type="text"/>\n  </div>\n</div>';this.el.addClass("link-popover").append(C);this.textEl=this.el.find(".link-text");this.urlEl=this.el.find(".link-url");this.unlinkEl=this.el.find(".btn-unlink");this.textEl.on("keyup",(function(D){return function(E){if(E.which===13){return}return D.target.text(D.textEl.val())}})(this));this.urlEl.on("keyup",(function(D){return function(F){var E;if(F.which===13){return}E=D.urlEl.val();if(!(/https?:\/\/|^\//ig.test(E)||!E)){E="http://"+E}return D.target.attr("href",E)}})(this));v([this.urlEl[0],this.textEl[0]]).on("keydown",(function(D){return function(E){if(E.which===13||E.which===27||(!E.shiftKey&&E.which===9&&v(E.target).hasClass("link-url"))){E.preventDefault();return setTimeout(function(){var F;F=document.createRange();D.editor.selection.setRangeAfter(D.target,F);D.hide();return D.editor.trigger("valuechanged")},0)}}})(this));return this.unlinkEl.on("click",(function(D){return function(E){var F,G;G=document.createTextNode(D.target.text());D.target.replaceWith(G);D.hide();F=document.createRange();D.editor.selection.setRangeAfter(G,F);return D.editor.trigger("valuechanged")}})(this))};B.prototype.show=function(){var C;C=1<=arguments.length?s.call(arguments,0):[];B.__super__.show.apply(this,C);this.textEl.val(this.target.text());return this.urlEl.val(this.target.attr("href"))};return B})(y);p.Toolbar.addButton(At);var Ai,An,Ah={}.hasOwnProperty,r=function(A,B){for(var D in B){if(Ah.call(B,D)){A[D]=B[D]}}function C(){this.constructor=A}C.prototype=B.prototype;A.prototype=new C();A.__super__=B.prototype;return A},s=[].slice;Ai=(function(B){r(A,B);function A(){return A.__super__.constructor.apply(this,arguments)}A.prototype.name="image";A.prototype.icon="picture-o";A.prototype.htmlTag="img";A.prototype.disableTag="pre, table";A.prototype.defaultImage="";A.prototype.needFocus=false;A.prototype._init=function(){if(this.editor.uploader!=null){this.menu=[{name:"upload-image",text:this._t("localImage")},{name:"external-image",text:this._t("externalImage")}]}else{this.menu=false}this.defaultImage=this.editor.opts.defaultImage;this.editor.body.on("click","img:not([data-non-image])",(function(C){return function(E){var F,D;F=v(E.currentTarget);D=document.createRange();D.selectNode(F[0]);C.editor.selection.selectRange(D);if(!C.editor.util.supportSelectionChange){C.editor.trigger("selectionchanged")}return false}})(this));this.editor.body.on("mouseup","img:not([data-non-image])",(function(C){return function(D){return false}})(this));this.editor.on("selectionchanged.image",(function(C){return function(){var E,F,D;D=C.editor.selection.getRange();if(D==null){return}E=v(D.cloneContents()).contents();if(E.length===1&&E.is("img:not([data-non-image])")){F=v(D.startContainer).contents().eq(D.startOffset);return C.popover.show(F)}else{return C.popover.hide()}}})(this));this.editor.on("valuechanged.image",(function(C){return function(){var D;D=C.editor.wrapper.find(".simditor-image-loading");if(!(D.length>0)){return}return D.each(function(G,H){var F,E,I;E=v(H);F=E.data("img");if(!(F&&F.parent().length>0)){E.remove();if(F){I=F.data("file");if(I){C.editor.uploader.cancel(I);if(C.editor.body.find("img.uploading").length<1){return C.editor.uploader.trigger("uploadready",[I])}}}}})}})(this));return A.__super__._init.call(this)};A.prototype.render=function(){var C;C=1<=arguments.length?s.call(arguments,0):[];A.__super__.render.apply(this,C);return this.popover=new An({button:this})};A.prototype.renderMenu=function(){var C,D,E;A.__super__.renderMenu.call(this);D=this.menuEl.find(".menu-item-upload-image");C=null;E=(function(F){return function(){if(C){C.remove()}return C=v('<input type="file" title="'+F._t("uploadImage")+'" accept="image/*">').appendTo(D)}})(this);E();D.on("click mousedown","input[type=file]",(function(F){return function(G){return G.stopPropagation()}})(this));D.on("change","input[type=file]",(function(F){return function(G){if(F.editor.inputManager.focused){F.editor.uploader.upload(C,{inline:true});E()}else{F.editor.one("focus",function(H){F.editor.uploader.upload(C,{inline:true});return E()});F.editor.focus()}return F.wrapper.removeClass("menu-on")}})(this));return this._initUploader()};A.prototype._initUploader=function(){if(this.editor.uploader==null){this.el.find(".btn-upload").remove();return}this.editor.uploader.on("beforeupload",(function(C){return function(E,D){var F;if(!D.inline){return}if(D.img){F=v(D.img)}else{F=C.createImage(D.name);D.img=F}F.addClass("uploading");F.data("file",D);return C.editor.uploader.readImageFile(D.obj,function(H){var G;if(!F.hasClass("uploading")){return}G=H?H.src:C.defaultImage;return C.loadImage(F,G,function(){if(C.popover.active){C.popover.refresh();return C.popover.srcEl.val(C._t("uploading")).prop("disabled",true)}})})}})(this));this.editor.uploader.on("uploadprogress",(function(C){return function(J,K,D,H){var F,G,E,I;if(!K.inline){return}I=D/H;I=(I*100).toFixed(0);if(I>99){I=99}G=K.img.data("mask");if(G){F=G.data("img");E=G.find("span");if(F&&F.parent().length>0&&I!==E.text()){return E.text(I)}else{return G.remove()}}}})(this));this.editor.uploader.on("uploadsuccess",(function(C){return function(F,H,G){var D,I,E;if(!H.inline){return}D=H.img;D.removeData("file");D.removeClass("uploading");I=D.data("mask");if(I){I.remove()}D.removeData("mask");if(G.success===false){E=G.msg||C._t("uploadFailed");alert(E);D.attr("src",C.defaultImage)}else{D.attr("src",G.file_path)}if(C.popover.active){C.popover.srcEl.prop("disabled",false);C.popover.srcEl.val(G.file_path)}C.editor.trigger("valuechanged");if(C.editor.body.find("img.uploading").length<1){return C.editor.uploader.trigger("uploadready",[H,G])}}})(this));return this.editor.uploader.on("uploaderror",(function(C){return function(F,I,J){var H,G,K,D;if(!I.inline){return}if(J.statusText==="abort"){return}if(J.responseText){try{D=v.parseJSON(J.responseText);K=D.msg}catch(E){F=E;K=C._t("uploadError")}alert(K)}H=I.img;H.removeData("file");H.removeClass("uploading");G=H.data("mask");if(G){G.remove()}H.removeData("mask");H.attr("src",C.defaultImage);if(C.popover.active){C.popover.srcEl.prop("disabled",false);C.popover.srcEl.val(C.defaultImage)}C.editor.trigger("valuechanged");if(C.editor.body.find("img.uploading").length<1){return C.editor.uploader.trigger("uploadready",[I,D])}}})(this))};A.prototype.status=function(C){if(C!=null){this.setDisabled(C.is(this.disableTag))}if(this.disabled){return true}};A.prototype.loadImage=function(F,C,E){var G,D;G=F.data("mask");if(!G){G=v('<div class="simditor-image-loading"><span></span></div>').hide().appendTo(this.editor.wrapper);if(F.hasClass("uploading")){G.addClass("uploading")}F.data("mask",G);G.data("img",F)}D=new Image();D.onload=(function(H){return function(){var L,J,K,I;if(G.hasClass("uploading")&&!F.hasClass("uploading")){return}K=D.width;L=D.height;F.attr({src:C,"data-image-size":K+","+L});if(F.hasClass("uploading")){H.editor.util.reflow(H.editor.body);I=H.editor.wrapper.offset();J=F.offset();G.css({top:J.top-I.top,left:J.left-I.left,width:F.width(),height:F.height()}).show()}else{G.remove();F.removeData("mask")}return E(D)}})(this);D.onerror=(function(H){return function(){E(false);G.remove();return F.removeData("mask")}})(this);return D.src=C};A.prototype.createImage=function(F){var E,C,G,D;if(F==null){F="Image"}if(!this.editor.inputManager.focused){this.editor.focus()}D=this.editor.selection.getRange();D.deleteContents();E=this.editor.util.closestBlockEl();if(E.is("p")&&!this.editor.util.isEmptyNode(E)){E=v("<p/>").append(this.editor.util.phBr).insertAfter(E);this.editor.selection.setRangeAtStartOf(E,D)}C=v("<img/>").attr("alt",F);D.insertNode(C[0]);G=E.next("p");if(!(G.length>0)){G=v("<p/>").append(this.editor.util.phBr).insertAfter(E)}this.editor.selection.setRangeAtStartOf(G);return C};A.prototype.command=function(C){var D;D=this.createImage();return this.loadImage(D,C||this.defaultImage,(function(E){return function(){E.editor.trigger("valuechanged");E.editor.util.reflow(D);D.click();return E.popover.one("popovershow",function(){E.popover.srcEl.focus();return E.popover.srcEl[0].select()})}})(this))};return A})(Ad);An=(function(B){r(A,B);function A(){return A.__super__.constructor.apply(this,arguments)}A.prototype.offset={top:6,left:-4};A.prototype.render=function(){var C;C='<div class="link-settings">\n  <div class="settings-field">\n    <label>'+(this._t("imageUrl"))+'</label>\n    <input class="image-src" type="text" tabindex="1" />\n    <a class="btn-upload" href="javascript:;" title="'+(this._t("uploadImage"))+'" tabindex="-1">\n      <span class="fa fa-upload"></span>\n    </a>\n  </div>\n  <div class="settings-field">\n    <label>'+(this._t("imageSize"))+'</label>\n    <input class="image-size" id="image-width" type="text" tabindex="2" />\n    <span class="times">×</span>\n    <input class="image-size" id="image-height" type="text" tabindex="3" />\n    <a class="btn-restore" href="javascript:;" title="'+(this._t("restoreImageSize"))+'" tabindex="-1">\n      <span class="fa fa-reply"></span>\n    </a>\n  </div>\n</div>';this.el.addClass("image-popover").append(C);this.srcEl=this.el.find(".image-src");this.srcEl.on("keydown",(function(D){return function(E){var G,F;if(!(E.which===13||E.which===27)){return}E.preventDefault();G=function(){D.button.editor.body.focus();D.button.editor.selection.setRangeAfter(D.target);return D.hide()};if(E.which===13&&!D.target.hasClass("uploading")){F=D.srcEl.val();if(/^data:image/.test(F)&&!D.editor.uploader){G();return}return D.button.loadImage(D.target,F,function(H){var I;if(!H){return}if(/^data:image/.test(F)){I=D.editor.util.dataURLtoBlob(F);I.name="Base64 Image.png";return D.editor.uploader.upload(I,{inline:true,img:D.target})}else{G();return D.editor.trigger("valuechanged")}})}else{return G()}}})(this));this.widthEl=this.el.find("#image-width");this.heightEl=this.el.find("#image-height");this.el.find(".image-size").on("blur",(function(D){return function(E){D._resizeImg(v(E.currentTarget));return D.el.data("popover").refresh()}})(this));this.el.find(".image-size").on("keyup",(function(D){return function(E){var F;F=v(E.currentTarget);if(!(E.which===13||E.which===27||E.which===9)){return D._resizeImg(F,true)}}})(this));this.el.find(".image-size").on("keydown",(function(D){return function(E){var F;F=v(E.currentTarget);if(E.which===13||E.which===27){E.preventDefault();if(E.which===13){D._resizeImg(F)}else{D._restoreImg()}D.button.editor.body.focus();D.button.editor.selection.setRangeAfter(D.target);return D.hide()}else{if(E.which===9){return D.el.data("popover").refresh()}}}})(this));this.el.find(".btn-restore").on("click",(function(D){return function(E){D._restoreImg();return D.el.data("popover").refresh()}})(this));this.editor.on("valuechanged",(function(D){return function(E){if(D.active){return D.refresh()}}})(this));return this._initUploader()};A.prototype._initUploader=function(){var C,D;C=this.el.find(".btn-upload");if(this.editor.uploader==null){C.remove();return}D=(function(E){return function(){if(E.input){E.input.remove()}return E.input=v('<input type="file" title="'+E._t("uploadImage")+'" accept="image/*">').appendTo(C)}})(this);D();this.el.on("click mousedown","input[type=file]",(function(E){return function(F){return F.stopPropagation()}})(this));return this.el.on("change","input[type=file]",(function(E){return function(F){E.editor.uploader.upload(E.input,{inline:true,img:E.target});return D()}})(this))};A.prototype._resizeImg=function(E,F){var G,C,D;if(F==null){F=false}C=E.val()*1;if(!(v.isNumeric(C)||C<0)){return}if(E.is(this.widthEl)){G=this.height*C/this.width;this.heightEl.val(G)}else{D=this.width*C/this.height;this.widthEl.val(D)}if(!F){return this.target.attr({width:D||C,height:G||C})}};A.prototype._restoreImg=function(){var C,D;C=((D=this.target.data("image-size"))!=null?D.split(","):void 0)||[this.width,this.height];this.target.attr({width:C[0]*1,height:C[1]*1});this.widthEl.val(C[0]);return this.heightEl.val(C[1])};A.prototype.show=function(){var C,D;D=1<=arguments.length?s.call(arguments,0):[];A.__super__.show.apply(this,D);C=this.target;this.width=C.width();this.height=C.height();if(C.hasClass("uploading")){return this.srcEl.val(this._t("uploading")).prop("disabled",true)}else{this.srcEl.val(C.attr("src")).prop("disabled",false);this.widthEl.val(this.width);return this.heightEl.val(this.height)}};return A})(y);p.Toolbar.addButton(Ai);var z,Ah={}.hasOwnProperty,r=function(A,B){for(var D in B){if(Ah.call(B,D)){A[D]=B[D]}}function C(){this.constructor=A}C.prototype=B.prototype;A.prototype=new C();A.__super__=B.prototype;return A};z=(function(B){r(A,B);function A(){return A.__super__.constructor.apply(this,arguments)}A.prototype.name="indent";A.prototype.icon="indent";A.prototype._init=function(){this.title=this._t(this.name)+" (Tab)";return A.__super__._init.call(this)};A.prototype.status=function(C){return true};A.prototype.command=function(){return this.editor.util.indent()};return A})(Ad);p.Toolbar.addButton(z);var Ak,Ah={}.hasOwnProperty,r=function(A,B){for(var D in B){if(Ah.call(B,D)){A[D]=B[D]}}function C(){this.constructor=A}C.prototype=B.prototype;A.prototype=new C();A.__super__=B.prototype;return A};Ak=(function(B){r(A,B);function A(){return A.__super__.constructor.apply(this,arguments)}A.prototype.name="outdent";A.prototype.icon="outdent";A.prototype._init=function(){this.title=this._t(this.name)+" (Shift + Tab)";return A.__super__._init.call(this)};A.prototype.status=function(C){return true};A.prototype.command=function(){return this.editor.util.outdent()};return A})(Ad);p.Toolbar.addButton(Ak);var Aa,Ah={}.hasOwnProperty,r=function(A,B){for(var D in B){if(Ah.call(B,D)){A[D]=B[D]}}function C(){this.constructor=A}C.prototype=B.prototype;A.prototype=new C();A.__super__=B.prototype;return A};Aa=(function(A){r(B,A);function B(){return B.__super__.constructor.apply(this,arguments)}B.prototype.name="hr";B.prototype.icon="minus";B.prototype.htmlTag="hr";B.prototype.status=function(C){return true};B.prototype.command=function(){var D,C,E,F;F=this.editor.util.furthestBlockEl();E=F.next();if(E.length>0){this.editor.selection.save()}else{C=v("<p/>").append(this.editor.util.phBr)}D=v("<hr/>").insertAfter(F);if(C){C.insertAfter(D);this.editor.selection.setRangeAtStartOf(C)}else{this.editor.selection.restore()}return this.editor.trigger("valuechanged")};return B})(Ad);p.Toolbar.addButton(Aa);var m,Ah={}.hasOwnProperty,r=function(A,B){for(var D in B){if(Ah.call(B,D)){A[D]=B[D]}}function C(){this.constructor=A}C.prototype=B.prototype;A.prototype=new C();A.__super__=B.prototype;return A};m=(function(B){r(A,B);function A(){return A.__super__.constructor.apply(this,arguments)}A.prototype.name="table";A.prototype.icon="table";A.prototype.htmlTag="table";A.prototype.disableTag="pre, li, blockquote";A.prototype.menu=true;A.prototype._init=function(){A.__super__._init.call(this);v.merge(this.editor.formatter._allowedTags,["tbody","tr","td","colgroup","col"]);v.extend(this.editor.formatter._allowedAttributes,{td:["rowspan","colspan"],col:["width"]});this._initShortcuts();this.editor.on("decorate",(function(C){return function(D,E){return E.find("table").each(function(F,G){return C.decorate(v(G))})}})(this));this.editor.on("undecorate",(function(C){return function(D,E){return E.find("table").each(function(F,G){return C.undecorate(v(G))})}})(this));this.editor.on("selectionchanged.table",(function(C){return function(E){var D,F;C.editor.body.find(".simditor-table td").removeClass("active");F=C.editor.selection.getRange();if(F==null){return}D=v(F.commonAncestorContainer);if(F.collapsed&&D.is(".simditor-table")){if(C.editor.selection.rangeAtStartOf(D)){D=D.find("td:first")}else{D=D.find("td:last")}C.editor.selection.setRangeAtEndOf(D)}return D.closest("td",C.editor.body).addClass("active")}})(this));this.editor.on("blur.table",(function(C){return function(D){return C.editor.body.find(".simditor-table td").removeClass("active")}})(this));this.editor.inputManager.addKeystrokeHandler("38","td",(function(C){return function(G,E){var H,F,D;F=E.parent("tr");H=F.prev("tr");if(!(H.length>0)){return true}D=F.find("td").index(E);C.editor.selection.setRangeAtEndOf(H.find("td").eq(D));return true}})(this));return this.editor.inputManager.addKeystrokeHandler("40","td",(function(C){return function(G,H){var F,E,D;E=H.parent("tr");F=E.next("tr");if(!(F.length>0)){return true}D=E.find("td").index(H);C.editor.selection.setRangeAtEndOf(F.find("td").eq(D));return true}})(this))};A.prototype.initResize=function(E){var C,D,F;F=E.parent(".simditor-table");C=E.find("colgroup");if(C.length<1){C=v("<colgroup/>").prependTo(E);E.find("tr:first td").each((function(G){return function(I,H){var J;return J=v("<col/>").appendTo(C)}})(this));this.refreshTableWidth(E)}D=v('<div class="simditor-resize-handle" contenteditable="false"></div>').appendTo(F);F.on("mousemove","td",(function(G){return function(L){var M,J,I,N,K,H;if(F.hasClass("resizing")){return}J=v(L.currentTarget);N=L.pageX-v(L.currentTarget).offset().left;if(N<5&&J.prev().length>0){J=J.prev()}if(J.next("td").length<1){D.hide();return}if((K=D.data("td"))!=null?K.is(J):void 0){D.show();return}I=J.parent().find("td").index(J);M=C.find("col").eq(I);if((H=D.data("col"))!=null?H.is(M):void 0){D.show();return}return D.css("left",J.position().left+J.outerWidth()-5).data("td",J).data("col",M).show()}})(this));F.on("mouseleave",(function(G){return function(H){return D.hide()}})(this));return F.on("mousedown",".simditor-resize-handle",(function(G){return function(H){var Q,O,S,I,J,M,P,K,L,N,R;Q=v(H.currentTarget);S=Q.data("td");O=Q.data("col");J=S.next("td");I=O.next("col");N=H.pageX;K=S.outerWidth()*1;L=J.outerWidth()*1;P=parseFloat(Q.css("left"));R=S.closest("table").width();M=50;v(document).on("mousemove.simditor-resize-table",function(W){var T,U,V;T=W.pageX-N;U=K+T;V=L-T;if(U<M){U=M;T=M-K;V=L-T}else{if(V<M){V=M;T=L-M;U=K+T}}O.attr("width",(U/R*100)+"%");I.attr("width",(V/R*100)+"%");return Q.css("left",P+T)});v(document).one("mouseup.simditor-resize-table",function(T){v(document).off(".simditor-resize-table");return F.removeClass("resizing")});F.addClass("resizing");return false}})(this))};A.prototype._initShortcuts=function(){this.editor.inputManager.addShortcut("ctrl+alt+up",(function(C){return function(D){C.editMenu.find(".menu-item[data-param=insertRowAbove]").click();return false}})(this));this.editor.inputManager.addShortcut("ctrl+alt+down",(function(C){return function(D){C.editMenu.find(".menu-item[data-param=insertRowBelow]").click();return false}})(this));this.editor.inputManager.addShortcut("ctrl+alt+left",(function(C){return function(D){C.editMenu.find(".menu-item[data-param=insertColLeft]").click();return false}})(this));return this.editor.inputManager.addShortcut("ctrl+alt+right",(function(C){return function(D){C.editMenu.find(".menu-item[data-param=insertColRight]").click();return false}})(this))};A.prototype.decorate=function(C){if(C.parent(".simditor-table").length>0){this.undecorate(C)}C.wrap('<div class="simditor-table"></div>');this.initResize(C);return C.parent()};A.prototype.undecorate=function(C){if(!(C.parent(".simditor-table").length>0)){return}return C.parent().replaceWith(C)};A.prototype.renderMenu=function(){v('<div class="menu-create-table">\n</div>\n<div class="menu-edit-table">\n  <ul>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="deleteRow"><span>'+(this._t("deleteRow"))+' ( Ctrl + Alt + → )</span></a></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="insertRowAbove"><span>'+(this._t("insertRowAbove"))+' ( Ctrl + Alt + ↑ )</span></a></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="insertRowBelow"><span>'+(this._t("insertRowBelow"))+' ( Ctrl + Alt + ↓ )</span></a></li>\n    <li><span class="separator"></span></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="deleteCol"><span>'+(this._t("deleteColumn"))+'</span></a></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="insertColLeft"><span>'+(this._t("insertColumnLeft"))+' ( Ctrl + Alt + ← )</span></a></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="insertColRight"><span>'+(this._t("insertColumnRight"))+' ( Ctrl + Alt + → )</span></a></li>\n    <li><span class="separator"></span></li>\n    <li><a tabindex="-1" unselectable="on" class="menu-item" href="javascript:;" data-param="deleteTable"><span>'+(this._t("deleteTable"))+"</span></a></li>\n  </ul>\n</div>").appendTo(this.menuWrapper);this.createMenu=this.menuWrapper.find(".menu-create-table");this.editMenu=this.menuWrapper.find(".menu-edit-table");this.createTable(6,6).appendTo(this.createMenu);this.createMenu.on("mouseenter","td",(function(C){return function(G){var D,F,E;C.createMenu.find("td").removeClass("selected");D=v(G.currentTarget);F=D.parent();E=F.find("td").index(D)+1;return F.prevAll("tr").addBack().find("td:lt("+E+")").addClass("selected")}})(this));this.createMenu.on("mouseleave",(function(C){return function(D){return v(D.currentTarget).find("td").removeClass("selected")}})(this));return this.createMenu.on("mousedown","td",(function(C){return function(D){var I,J,E,G,F,H;C.wrapper.removeClass("menu-on");if(!C.editor.inputManager.focused){return}E=v(D.currentTarget);G=E.parent();F=G.find("td").index(E)+1;H=G.prevAll("tr").length+1;J=C.createTable(H,F,true);I=C.editor.util.closestBlockEl();if(C.editor.util.isEmptyNode(I)){I.replaceWith(J)}else{I.after(J)}C.decorate(J);C.editor.selection.setRangeAtStartOf(J.find("td:first"));C.editor.trigger("valuechanged");return false}})(this))};A.prototype.createTable=function(F,K,L){var M,D,E,J,G,C,H,I;M=v("<table/>");D=v("<tbody/>").appendTo(M);for(C=H=0;0<=F?H<F:H>F;C=0<=F?++H:--H){J=v("<tr/>").appendTo(D);for(G=I=0;0<=K?I<K:I>K;G=0<=K?++I:--I){E=v("<td/>").appendTo(J);if(L){E.append(this.editor.util.phBr)}}}return M};A.prototype.refreshTableWidth=function(D){var C,E;E=D.width();C=D.find("col");return D.find("tr:first td").each((function(F){return function(G,I){var H;H=C.eq(G);return H.attr("width",(v(I).outerWidth()/E*100)+"%")}})(this))};A.prototype.setActive=function(C){A.__super__.setActive.call(this,C);if(C){this.createMenu.hide();return this.editMenu.show()}else{this.createMenu.show();return this.editMenu.hide()}};A.prototype.deleteRow=function(D){var C,E,F;E=D.parent("tr");if(E.siblings("tr").length<1){return this.deleteTable(D)}else{C=E.next("tr");if(!(C.length>0)){C=E.prev("tr")}F=E.find("td").index(D);E.remove();return this.editor.selection.setRangeAtEndOf(C.find("td").eq(F))}};A.prototype.insertRow=function(E,K){var J,H,I,G,D,F,C;if(K==null){K="after"}I=E.parent("tr");H=I.closest("table");G=0;H.find("tr").each((function(L){return function(N,M){return G=Math.max(G,v(M).find("td").length)}})(this));J=v("<tr/>");for(D=C=1;1<=G?C<=G:C>=G;D=1<=G?++C:--C){v("<td/>").append(this.editor.util.phBr).appendTo(J)}I[K](J);F=I.find("td").index(E);return this.editor.selection.setRangeAtStartOf(J.find("td").eq(F))};A.prototype.deleteCol=function(F){var D,C,E,G;E=F.parent("tr");if(E.siblings("tr").length<1&&F.siblings("td").length<1){return this.deleteTable(F)}else{G=E.find("td").index(F);D=F.next("td");if(!(D.length>0)){D=E.prev("td")}C=E.closest("table");C.find("col").eq(G).remove();C.find("tr").each((function(H){return function(J,I){return v(I).find("td").eq(G).remove()}})(this));this.refreshTableWidth(C);return this.editor.selection.setRangeAtEndOf(D)}};A.prototype.insertCol=function(E,K){var C,J,D,H,I,F,L,G;if(K==null){K="after"}I=E.parent("tr");F=I.find("td").index(E);H=E.closest("table");C=H.find("col").eq(F);H.find("tr").each((function(M){return function(P,N){var O;O=v("<td/>").append(M.editor.util.phBr);return v(N).find("td").eq(F)[K](O)}})(this));J=v("<col/>");C[K](J);L=H.width();G=Math.max(parseFloat(C.attr("width"))/2,50/L*100);C.attr("width",G+"%");J.attr("width",G+"%");this.refreshTableWidth(H);D=K==="after"?E.next("td"):E.prev("td");return this.editor.selection.setRangeAtStartOf(D)};A.prototype.deleteTable=function(C){var D,E;E=C.closest(".simditor-table");D=E.next("p");E.remove();if(D.length>0){return this.editor.selection.setRangeAtStartOf(D)}};A.prototype.command=function(C){var D,E;E=this.editor.selection.getRange();D=v(E.commonAncestorContainer).closest("td");if(!(D.length>0)){return}if(C==="deleteRow"){this.deleteRow(D)}else{if(C==="insertRowAbove"){this.insertRow(D,"before")}else{if(C==="insertRowBelow"){this.insertRow(D)}else{if(C==="deleteCol"){this.deleteCol(D)}else{if(C==="insertColLeft"){this.insertCol(D,"before")}else{if(C==="insertColRight"){this.insertCol(D)}else{if(C==="deleteTable"){this.deleteTable(D)}else{return}}}}}}}return this.editor.trigger("valuechanged")};return A})(Ad);p.Toolbar.addButton(m);var Am,Ah={}.hasOwnProperty,r=function(A,B){for(var D in B){if(Ah.call(B,D)){A[D]=B[D]}}function C(){this.constructor=A}C.prototype=B.prototype;A.prototype=new C();A.__super__=B.prototype;return A};Am=(function(A){r(B,A);function B(){return B.__super__.constructor.apply(this,arguments)}B.prototype.name="strikethrough";B.prototype.icon="strikethrough";B.prototype.htmlTag="strike";B.prototype.disableTag="pre";B.prototype.status=function(C){var D;if(C!=null){this.setDisabled(C.is(this.disableTag))}if(this.disabled){return true}D=document.queryCommandState("strikethrough")===true;this.setActive(D);return D};B.prototype.command=function(){document.execCommand("strikethrough");this.editor.trigger("valuechanged");return v(document).trigger("selectionchange")};return B})(Ad);p.Toolbar.addButton(Am);return p}));